<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kingdom Connection</title>
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIktpbmdkb20gQ29ubmVjdGlvbiIsCiAgInNob3J0X25hbWUiOiAiS2luZ2RvbSIsCiAgImRlc2NyaXB0aW9uIjogIkNvdXBsZXMgam91cm5hbCBmb3Igc3Bpcml0dWFsIGNvbm5lY3Rpb24iLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZhZmFmYSIsCiAgInRoZW1lX2NvbG9yIjogIiM2NjdlZWEiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vY2hhbmVsbGVqYW5hZS9raW5nZG9tY29ubmVjdGlvbi9tYWluL2xvZ28ucG5nIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9LAogICAgewogICAgICAic3JjIjogImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9jaGFuZWxsZWphbmFlL2tpbmdkb21jb25uZWN0aW9uL21haW4vbG9nby5wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/chanellejanae/kingdomconnection/main/logo.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/chanellejanae/kingdomconnection/main/logo.png">
    
    <!-- Apple Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Kingdom Connection">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #fafafa;
            color: #2c2c2c;
            line-height: 1.6;
        }

        /* Navigation Bar */
        .navbar {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.25rem;
            font-weight: 700;
            color: #2c2c2c;
            text-decoration: none;
        }

        .navbar-brand img {
            width: 32px;
            height: 32px;
            border-radius: 6px;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .user-info:hover {
            background: #f8f9fa;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-name {
            font-weight: 500;
            color: #2c2c2c;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 160px;
            display: none;
            z-index: 1000;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            color: #495057;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        /* Tab Navigation */
        .tab-navigation {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 0 24px;
            display: flex;
            gap: 0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-btn:hover {
            color: #495057;
            background: #f8f9fa;
        }

        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Daily Journal Tab */
        .journal-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .journal-date {
            font-size: 18px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .journal-subtitle {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* Relationship Stats */
        .relationship-stats {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            text-align: center;
            min-width: 100px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .question-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid #f0f0f0;
            text-align: center;
        }

        .question-category {
            font-size: 12px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .question-text {
            font-size: 18px;
            line-height: 1.5;
            color: #2c2c2c;
            margin: 0;
            font-weight: 500;
        }

        .journal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .journal-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid #f0f0f0;
        }

        .journal-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f5f5f5;
        }

        .partner-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .partner-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .partner-name {
            font-weight: 500;
            color: #2c2c2c;
            font-size: 16px;
        }

        .journal-area {
            margin-bottom: 20px;
        }

        .journal-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #495057;
            font-size: 14px;
        }

        .journal-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background: #fafafa;
        }

        .journal-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .save-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
        }

        .save-btn:hover {
            background: #5a67d8;
        }

        .save-btn:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }

        /* Weekly Check-in */
        .weekly-checkin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            text-align: center;
        }

        .weekly-checkin h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
        }

        .weekly-checkin p {
            margin: 0 0 20px 0;
            opacity: 0.9;
        }

        .checkin-questions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 20px;
        }

        .checkin-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .checkin-card h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
        }

        .checkin-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }

        .checkin-textarea::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .checkin-textarea:focus {
            outline: none;
            border-color: rgba(255,255,255,0.4);
            background: rgba(255,255,255,0.15);
        }

        .checkin-save-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 16px;
        }

        .checkin-save-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* History Tab */
        .history-filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: center;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .history-grid {
            display: grid;
            gap: 16px;
        }

        .history-entry {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            border: 1px solid #f0f0f0;
        }

        .history-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .history-date {
            font-weight: 500;
            color: #495057;
        }

        .history-category {
            font-size: 12px;
            color: #6c757d;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .history-question {
            font-weight: 500;
            margin-bottom: 8px;
            color: #2c2c2c;
        }

        .history-response {
            color: #495057;
            line-height: 1.5;
        }

        /* Date Night Cards */
        .date-night-section {
            text-align: center;
        }

        .date-night-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c2c2c;
        }

        .date-night-subtitle {
            color: #6c757d;
            margin-bottom: 32px;
            font-size: 16px;
        }

        .card-stack {
            position: relative;
            width: 320px;
            height: 200px;
            margin: 0 auto 32px;
            perspective: 1000px;
        }

        .date-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.1),
                0 1px 3px rgba(0,0,0,0.08),
                inset 0 1px 0 rgba(255,255,255,0.9);
            transform-style: preserve-3d;
        }

        .date-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.2) 100%);
            border-radius: 14px;
            pointer-events: none;
        }

        .date-card:nth-child(1) { 
            transform: rotate(-2deg) translateY(0px) translateZ(0px);
            z-index: 1;
        }
        .date-card:nth-child(2) { 
            transform: rotate(1deg) translateY(-4px) translateZ(10px);
            z-index: 2;
        }
        .date-card:nth-child(3) { 
            transform: rotate(-0.5deg) translateY(-8px) translateZ(20px);
            z-index: 3;
        }

        .date-card:hover {
            transform: rotate(0deg) translateY(-15px) translateZ(50px) scale(1.05);
            z-index: 10;
            box-shadow: 
                0 15px 35px rgba(0,0,0,0.15),
                0 5px 15px rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.9);
        }

        .card-question {
            font-size: 16px;
            font-weight: 500;
            color: #2c2c2c;
            line-height: 1.4;
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }

        .draw-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .draw-btn:hover {
            background: #5a67d8;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c2c2c;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .close-btn:hover {
            background: #f8f9fa;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #495057;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
            margin-bottom: 12px;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Auth Screens */
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 32px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .auth-title {
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 32px;
        }

        .auth-logo {
            width: 100px;
            height: 100px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 
                0 0 20px rgba(102, 126, 234, 0.4),
                0 0 40px rgba(118, 75, 162, 0.3),
                0 0 60px rgba(102, 126, 234, 0.2);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
        }

        .auth-toggle button {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #48bb78;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #e53e3e;
        }

        .notification.warning {
            background: #dd6b20;
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 12px 16px;
            }
            
            .container {
                padding: 16px;
            }
            
            .journal-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .checkin-questions {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .tab-navigation {
                padding: 0 16px;
                overflow-x: auto;
            }
            
            .tab-btn {
                padding: 16px 20px;
                white-space: nowrap;
            }
            
            .card-stack {
                width: 280px;
                height: 180px;
            }
            
            .modal-content {
                margin: 20px;
                width: calc(100% - 40px);
            }
            
            .relationship-stats {
                flex-wrap: wrap;
                gap: 12px;
                justify-content: center;
            }
            
            .stat-card {
                min-width: 80px;
                padding: 12px 16px;
                flex: 1;
                max-width: 120px;
            }
            
            .stat-number {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <div style="text-align: center; margin-bottom: 24px;">
            <img src="https://raw.githubusercontent.com/chanellejanae/kingdomconnection/main/logo.png" alt="Kingdom Connection" class="auth-logo">
        </div>
        <h1 class="auth-title">Kingdom Connection</h1>
        <form id="authForm">
            <div class="form-group">
                <label for="email" class="form-label">Email</label>
                <input type="email" id="email" class="form-input" required>
            </div>
            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <input type="password" id="password" class="form-input" required>
            </div>
            <button type="submit" class="btn" id="authSubmit">Sign In</button>
        </form>
        <div class="auth-toggle">
            <button type="button" class="btn btn-secondary" id="createAccountBtn">Create Account</button>
            <button type="button" class="btn btn-secondary" id="forgotPasswordBtn">Forgot Password?</button>
        </div>
    </div>

    <!-- Couple Code Screen -->
    <div id="coupleCodeScreen" class="auth-container" style="display: none;">
        <div style="text-align: center; margin-bottom: 24px;">
            <img src="https://raw.githubusercontent.com/chanellejanae/kingdomconnection/main/logo.png" alt="Kingdom Connection" class="auth-logo">
        </div>
        <h1 class="auth-title">Connect with Your Partner</h1>
        <p style="text-align: center; color: #6c757d; margin-bottom: 24px;">
            Share your couple code with your partner or enter theirs to connect your journals
        </p>
        
        <div class="form-group">
            <label class="form-label">Your Couple Code</label>
            <div style="display: flex; align-items: center; gap: 12px;">
                <input type="text" id="yourCoupleCode" class="form-input" readonly style="background: #f8f9fa;">
                <button type="button" class="btn" onclick="copyCode()" style="width: auto; padding: 10px 16px; margin: 0;">Copy</button>
            </div>
            <small style="color: #6c757d; font-size: 12px;">Share this code with your partner</small>
        </div>
        
        <div style="text-align: center; margin: 20px 0; color: #dee2e6; font-weight: bold;">OR</div>
        
        <form id="coupleCodeForm">
            <div class="form-group">
                <label for="partnerCode" class="form-label">Enter Partner's Code</label>
                <input type="text" id="partnerCode" class="form-input" placeholder="Enter your partner's couple code" style="text-transform: uppercase;">
            </div>
            <button type="submit" class="btn">Connect with Partner</button>
        </form>
        
        <div style="text-align: center; margin-top: 20px;">
            <button type="button" class="btn btn-secondary" onclick="skipCoupleCode()">Skip for Now</button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading">
        <p>Loading your journal...</p>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <!-- Navigation Bar -->
        <nav class="navbar">
            <a href="#" class="navbar-brand">
                <img src="https://raw.githubusercontent.com/chanellejanae/kingdomconnection/main/logo.png" alt="Kingdom Connection">
                Kingdom Connection
            </a>
            <div class="navbar-user">
                <div class="user-info" onclick="toggleUserDropdown()">
                    <div class="user-avatar" id="navProfilePic">
                        <span id="navProfileInitials">U</span>
                    </div>
                    <span class="user-name" id="navDisplayName">User</span>
                    <span style="margin-left: 4px;">▼</span>
                </div>
                <div class="dropdown-menu" id="userDropdown">
                    <button class="dropdown-item" onclick="openSettings()">⚙️ Settings</button>
                    <button class="dropdown-item" onclick="signOut()">🚪 Logout</button>
                </div>
            </div>
        </nav>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('daily')">📝 Daily Journal</button>
            <button class="tab-btn" onclick="switchTab('history')">📚 Reflection History</button>
            <button class="tab-btn" onclick="switchTab('datenight')">💝 Date Night Cards</button>
        </div>

        <div class="container">
            <!-- Daily Journal Tab -->
            <div id="dailyTab" class="tab-content active">
                <div class="journal-header">
                    <div class="journal-date" id="todaysDate">Today's Date</div>
                    <div class="journal-subtitle">Share your hearts and grow closer together</div>
                    
                    <!-- Relationship Stats -->
                    <div class="relationship-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="daysTogether">0</div>
                            <div class="stat-label">Days Together</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="currentStreak">0</div>
                            <div class="stat-label">Current Streak</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalEntries">0</div>
                            <div class="stat-label">Total Reflections</div>
                        </div>
                    </div>
                </div>

                <!-- Weekly Check-in (shows every 7 days) -->
                <div id="weeklyCheckin" class="weekly-checkin" style="display: none;">
                    <h3>💕 Weekly Check-in</h3>
                    <p>Take a moment to reflect on your week together</p>
                    <div class="checkin-questions">
                        <div class="checkin-card">
                            <h4>What brought us closer this week?</h4>
                            <textarea class="checkin-textarea" id="checkinQ1" placeholder="Share what strengthened your bond..."></textarea>
                            <button class="checkin-save-btn" onclick="saveCheckin(1)">Save Reflection</button>
                        </div>
                        <div class="checkin-card">
                            <h4>How can we grow together next week?</h4>
                            <textarea class="checkin-textarea" id="checkinQ2" placeholder="Share your hopes and goals..."></textarea>
                            <button class="checkin-save-btn" onclick="saveCheckin(2)">Save Reflection</button>
                        </div>
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-category" id="todaysCategory">✨ Spiritual Connection</div>
                    <p class="question-text" id="todaysQuestion">Loading today's question...</p>
                </div>

                <div class="journal-grid">
                    <div class="journal-card">
                        <div class="journal-card-header">
                            <div class="partner-avatar" id="partnerAvatar1">
                                <span id="partnerInitials1">P1</span>
                            </div>
                            <span class="partner-name" id="partnerName1">Partner 1</span>
                        </div>
                        
                        <div class="journal-area">
                            <label for="journal1" class="journal-label">Your thoughts and reflections:</label>
                            <textarea id="journal1" class="journal-textarea" placeholder="Share your heart..."></textarea>
                        </div>

                        <button class="save-btn" onclick="saveEntry(1)" id="saveBtn1">Save Entry</button>
                    </div>

                    <div class="journal-card">
                        <div class="journal-card-header">
                            <div class="partner-avatar" id="partnerAvatar2">
                                <span id="partnerInitials2">P2</span>
                            </div>
                            <span class="partner-name" id="partnerName2">Partner 2</span>
                        </div>
                        
                        <div class="journal-area">
                            <label for="journal2" class="journal-label">Your thoughts and reflections:</label>
                            <textarea id="journal2" class="journal-textarea" placeholder="Share your heart..."></textarea>
                        </div>

                        <button class="save-btn" onclick="saveEntry(2)" id="saveBtn2">Save Entry</button>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="historyTab" class="tab-content">
                <div class="history-filters">
                    <label for="monthFilter">Filter by month:</label>
                    <select id="monthFilter" class="filter-select" onchange="filterHistory()">
                        <option value="">All entries</option>
                    </select>
                    <label for="categoryFilter">Filter by category:</label>
                    <select id="categoryFilter" class="filter-select" onchange="filterHistory()">
                        <option value="">All categories</option>
                    </select>
                </div>
                <div class="history-grid" id="historyGrid">
                    <!-- History entries will be loaded here -->
                </div>
            </div>

            <!-- Date Night Tab -->
            <div id="datenightTab" class="tab-content">
                <div class="date-night-section">
                    <h2 class="date-night-title">💝 Date Night Cards</h2>
                    <p class="date-night-subtitle">Draw a card for deeper conversation during your special time together</p>
                    
                    <div class="card-stack">
                        <div class="date-card">
                            <p class="card-question" id="dateCard1">What's your favorite memory of us?</p>
                        </div>
                        <div class="date-card">
                            <p class="card-question" id="dateCard2">How do you feel most loved by me?</p>
                        </div>
                        <div class="date-card">
                            <p class="card-question" id="dateCard3">What dream do we share for our future?</p>
                        </div>
                    </div>
                    
                    <button class="draw-btn" onclick="drawNewCards()">Draw New Cards</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="close-btn" onclick="closeSettings()">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="displayNameInput" class="form-label">Display Name</label>
                <input type="text" id="displayNameInput" class="form-input" placeholder="Enter your name">
            </div>
            
            <div class="form-group">
                <label for="profilePictureInput" class="form-label">Profile Picture</label>
                <input type="file" id="profilePictureInput" class="form-input" accept="image/*" onchange="handleProfilePictureUpload(event)">
                <small style="color: #6c757d; font-size: 12px;">Choose a photo to personalize your profile</small>
            </div>
            
            <div class="form-group">
                <label for="anniversaryInput" class="form-label">Anniversary Date</label>
                <input type="date" id="anniversaryInput" class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label">Your Couple Code</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <input type="text" id="settingsCoupleCode" class="form-input" readonly style="background: #f8f9fa;">
                    <button type="button" class="btn" onclick="copySettingsCode()" style="width: auto; padding: 10px 16px; margin: 0;">Copy</button>
                </div>
                <small style="color: #6c757d; font-size: 12px;">Share this code with your partner to connect your journals</small>
            </div>
            
            <div class="form-group">
                <label for="partnerCodeInput" class="form-label">Connect with Partner</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <input type="text" id="partnerCodeInput" class="form-input" placeholder="Enter partner's code" style="text-transform: uppercase;">
                    <button type="button" class="btn" onclick="connectPartnerFromSettings()" style="width: auto; padding: 10px 16px; margin: 0;">Connect</button>
                </div>
                <small style="color: #6c757d; font-size: 12px;">Enter your partner's couple code to link your accounts</small>
            </div>
            
            <button class="btn" onclick="saveSettings()">Save Changes</button>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Reset Password</h2>
                <button class="close-btn" onclick="closeForgotPassword()">&times;</button>
            </div>
            
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label for="resetEmail" class="form-label">Email Address</label>
                    <input type="email" id="resetEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                <button type="submit" class="btn">Send Reset Link</button>
            </form>
            
            <div style="text-align: center; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeForgotPassword()">Back to Sign In</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        Entry saved! 💕
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA3jL36hYZBmQsjuI02VY8FfNRvRGuTvKk",
            authDomain: "kingdomconnection-ac1cd.firebaseapp.com",
            projectId: "kingdomconnection-ac1cd",
            storageBucket: "kingdomconnection-ac1cd.firebasestorage.app",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:798bed278e7104fe153cae",
            measurementId: "G-BX9X4ZXCXX"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let isSignUp = false;
        let currentCoupleId = null;
        let currentTab = 'daily';

        // All 370 questions organized by 27 categories
        const questionCategories = {
            "✨ Spiritual Connection": [
                "How did you feel God's presence today?",
                "What's one thing you're praying about for us right now?",
                "How can we grow closer to God together this week?",
                "What Bible verse has been speaking to your heart lately?",
                "How do you see God working in our relationship?",
                "What's one way we can serve God together?",
                "How can we make prayer a bigger part of our daily routine?",
                "What spiritual goal do you have for us as a couple?",
                "How has your faith grown since we've been together?",
                "What's one thing you're grateful to God for today?",
                "How do you feel when we worship together?",
                "What's a spiritual discipline you'd like us to practice together?",
                "How has God used our relationship to shape you?",
                "What's your favorite way to connect with God as a couple?",
                "How can we better honor God in our relationship?"
            ],
            "💬 Emotional Intimacy": [
                "What's something you've been thinking about but haven't shared yet?",
                "How are you feeling about us right now?",
                "What makes you feel most connected to me?",
                "What's one fear you have about our relationship?",
                "How can I better support you emotionally?",
                "What's something that made you smile today?",
                "How do you feel when we're apart?",
                "What's one thing you need from me right now?",
                "How do you prefer to receive comfort when you're upset?",
                "What's your favorite thing about our emotional connection?",
                "What emotion do you struggle to express to me?",
                "How do you feel most understood by me?",
                "What's something vulnerable you want to share?",
                "How can we create more emotional safety together?",
                "What makes you feel emotionally fulfilled in our relationship?"
            ],
            "💞 Relationship Reflection": [
                "What's one thing we've learned about each other recently?",
                "How have we grown as a couple this month?",
                "What's your favorite memory of us from this week?",
                "What challenge have we overcome together?",
                "How do we handle disagreements well?",
                "What's something we do that makes us unique as a couple?",
                "What tradition would you like us to start?",
                "How do we bring out the best in each other?",
                "What's one thing you admire about how we communicate?",
                "What makes our relationship special to you?",
                "What pattern in our relationship are you most grateful for?",
                "How do we show respect for each other?",
                "What's our greatest strength as a couple?",
                "How do we handle stress together?",
                "What's something we've improved on recently?"
            ],
            "🌿 Gratitude + Joy": [
                "What's something small I did that meant a lot to you?",
                "What made you laugh recently?",
                "What are you most grateful for in our relationship?",
                "What's a simple pleasure we enjoy together?",
                "How do we create joy in ordinary moments?",
                "What's your favorite way we spend time together?",
                "What's something about me that always makes you smile?",
                "What blessing in our relationship surprised you?",
                "How do we celebrate each other well?",
                "What's one thing that makes you excited about our future?",
                "What daily habit of mine brings you joy?",
                "How do we find humor together?",
                "What's your favorite thing about our home together?",
                "What simple moment with me felt perfect recently?",
                "How do we practice gratitude as a couple?"
            ],
            "🕊 Growth + Purpose": [
                "How are you growing personally right now?",
                "What's one goal you're working toward?",
                "How can I encourage you in your dreams?",
                "What's something new you want to learn or try?",
                "How do you see us growing together?",
                "What's one way we can challenge each other positively?",
                "What purpose do you feel God has for our relationship?",
                "How can we better support each other's individual callings?",
                "What's one area where you want to grow spiritually?",
                "How do we balance personal growth with growing together?",
                "What skill would you like us to develop as a couple?",
                "How can we better serve our community together?",
                "What legacy do you want us to leave?",
                "How do we encourage each other's personal development?",
                "What's a challenge that would help us grow?"
            ],
            "💝 Love Languages": [
                "How do you feel most loved by me?",
                "What's your favorite way I show affection?",
                "How can I better speak your love language this week?",
                "What gesture of love means the most to you?",
                "How do you like to receive encouragement?",
                "What's your favorite compliment I've given you?",
                "How do you prefer to be comforted?",
                "What act of service would mean the world to you?",
                "How do you feel when I give you my full attention?",
                "What's your favorite way we show physical affection?",
                "How can I better express my love for you?",
                "What makes you feel most appreciated?",
                "How do you like to celebrate special moments?",
                "What's your favorite love note or text I've sent?",
                "How do we show love in our daily routines?"
            ],
            "🏠 Home + Family": [
                "What makes our home feel like a sanctuary?",
                "How do you envision our future family?",
                "What family tradition would you like to start?",
                "How can we make our home more welcoming?",
                "What's your favorite room in our home and why?",
                "How do we want to raise our children?",
                "What values are most important to pass down?",
                "How can we better manage our household together?",
                "What's your dream for our family life?",
                "How do we create peace in our home?",
                "What role do you want extended family to play?",
                "How can we make our home a place of rest?",
                "What's your favorite family memory growing up?",
                "How do we want to handle holidays and celebrations?",
                "What makes you feel most at home with me?"
            ],
            "💰 Dreams + Goals": [
                "What's a dream you have for our future together?",
                "How can we better support each other's goals?",
                "What adventure would you love us to take?",
                "What's something you want to accomplish this year?",
                "How do we prioritize our shared dreams?",
                "What goal are you most excited about?",
                "How can we save for something meaningful together?",
                "What's a skill you'd like us to learn together?",
                "What does success look like for our relationship?",
                "How do we balance individual and couple goals?",
                "What's a place you'd love to visit together?",
                "What project would you like us to work on?",
                "How can we better plan for our future?",
                "What's a dream that scares and excites you?",
                "How do we encourage each other's ambitions?"
            ],
            "🎯 Communication": [
                "How can we communicate better during disagreements?",
                "What's something you wish I understood better about you?",
                "How do you prefer to discuss difficult topics?",
                "What's your favorite way we connect through conversation?",
                "How can I be a better listener for you?",
                "What topic would you like us to talk about more?",
                "How do we handle misunderstandings well?",
                "What's something you appreciate about how we communicate?",
                "How can we make more time for meaningful conversations?",
                "What's a conversation we've been avoiding?",
                "How do you feel heard and understood by me?",
                "What's your favorite deep conversation we've had?",
                "How can we better share our daily experiences?",
                "What communication habit would benefit our relationship?",
                "How do we show respect when we disagree?"
            ],
            "🌟 Personal Growth": [
                "What's something new you've learned about yourself recently?",
                "How have I helped you grow as a person?",
                "What personal challenge are you working through?",
                "What strength of yours am I helping to develop?",
                "How do you want to grow in the next year?",
                "What habit would you like to change or develop?",
                "How can I better support your personal development?",
                "What's something you're proud of accomplishing?",
                "How do you handle personal setbacks?",
                "What aspect of yourself are you most working on?",
                "How do we maintain our individual identities in our relationship?",
                "What's a fear you're working to overcome?",
                "How do you want me to challenge you to grow?",
                "What's your biggest area of personal growth right now?",
                "How do we celebrate each other's personal victories?"
            ],
            "🎉 Fun + Adventure": [
                "What's the most fun we've had together recently?",
                "What adventure would you love to go on with me?",
                "How can we add more playfulness to our relationship?",
                "What's your favorite way we have fun together?",
                "What new activity would you like us to try?",
                "How do we keep the spark alive in our relationship?",
                "What's your favorite date we've been on?",
                "How can we be more spontaneous together?",
                "What makes you laugh the hardest with me?",
                "What's a fun tradition we should start?",
                "How do we make ordinary moments more fun?",
                "What's your favorite way to celebrate together?",
                "What adventure are you most excited about?",
                "How can we create more joyful memories?",
                "What's the silliest thing we do together?"
            ],
            "💪 Challenges + Growth": [
                "What challenge has made our relationship stronger?",
                "How do we support each other through difficult times?",
                "What's something difficult we've overcome together?",
                "How can we better handle stress as a couple?",
                "What challenge are we currently facing together?",
                "How do we grow from our mistakes?",
                "What's your biggest fear about our future?",
                "How can we better prepare for life's challenges?",
                "What difficult conversation do we need to have?",
                "How do we maintain hope during tough times?",
                "What's something we need to work on as a couple?",
                "How do we handle external pressures on our relationship?",
                "What challenge would help us grow stronger?",
                "How can we better support each other's struggles?",
                "What's a lesson we've learned from a difficult time?"
            ],
            "🤝 Friendship": [
                "What do you love most about being my friend?",
                "How can we strengthen our friendship within our relationship?",
                "What's your favorite thing we do as friends?",
                "How do we maintain our friendship alongside romance?",
                "What makes you laugh when we're just hanging out?",
                "What's your favorite casual activity we do together?",
                "How can we better support each other as friends?",
                "What do you appreciate about our friendship?",
                "How do we have fun without any pressure?",
                "What's your favorite inside joke we share?",
                "How can we spend more quality friend time together?",
                "What makes our friendship unique?",
                "How do we encourage each other as friends?",
                "What's something fun we should do more often?",
                "How do we keep our friendship fresh and exciting?"
            ],
            "🌱 Seasons + Change": [
                "How do you feel about the current season of our relationship?",
                "What changes are you excited about in our future?",
                "How can we better adapt to life changes together?",
                "What season of our relationship has been your favorite?",
                "How do we handle transitions well as a couple?",
                "What change would you like to see in our relationship?",
                "How can we embrace new seasons of life together?",
                "What's something that's evolved beautifully in our relationship?",
                "How do we maintain stability during times of change?",
                "What new chapter are you excited to start with me?",
                "How can we better prepare for future changes?",
                "What's remained constant in our relationship through changes?",
                "How do we support each other through personal changes?",
                "What seasonal tradition do you love most?",
                "How can we celebrate the different seasons of our love?"
            ],
            "💎 Values + Beliefs": [
                "What value do we share that you're most grateful for?",
                "How do our different perspectives strengthen us?",
                "What belief of mine has influenced you positively?",
                "How can we better align our values in daily life?",
                "What principle guides our relationship decisions?",
                "How do we handle differences in opinion respectfully?",
                "What value would you like us to focus on more?",
                "How do our shared beliefs shape our future plans?",
                "What's something you've learned from my perspective?",
                "How can we better live out our values together?",
                "What belief system do you want to pass to our children?",
                "How do we make decisions based on our shared values?",
                "What's a value you've developed since being with me?",
                "How do our values influence our daily choices?",
                "What principle do you want our relationship to be known for?"
            ],
            "🎨 Creativity + Interests": [
                "What creative project would you love us to do together?",
                "How can we better support each other's hobbies?",
                "What's your favorite way we express creativity together?",
                "What new interest would you like to explore with me?",
                "How do our different interests complement each other?",
                "What's something creative you'd like to learn?",
                "How can we make more time for our individual interests?",
                "What hobby of mine do you find most interesting?",
                "How do we inspire each other's creativity?",
                "What's a skill you'd like us to develop together?",
                "How can we better appreciate each other's talents?",
                "What creative date idea excites you most?",
                "How do we encourage each other's artistic expression?",
                "What interest of yours would you like me to try?",
                "How can we create more beauty in our daily life?"
            ],
            "🌍 Service + Impact": [
                "How can we better serve our community together?",
                "What cause are you passionate about that we could support?",
                "How do we make a positive impact as a couple?",
                "What's your favorite way we've served others together?",
                "How can we use our relationship to bless others?",
                "What injustice would you like us to address together?",
                "How can we better love our neighbors?",
                "What's a way we could volunteer together regularly?",
                "How do we model healthy relationships for others?",
                "What legacy of service do you want us to leave?",
                "How can we better support those in need?",
                "What's something we could do to improve our community?",
                "How do we encourage each other in serving others?",
                "What mission could we take on as a couple?",
                "How can we use our gifts to serve God together?"
            ],
            "🏃‍♀️ Health + Wellness": [
                "How can we better support each other's health goals?",
                "What healthy habit would you like us to start together?",
                "How do we encourage each other's physical wellness?",
                "What's your favorite way we stay active together?",
                "How can we improve our mental health as a couple?",
                "What wellness goal are you working toward?",
                "How do we handle stress in healthy ways?",
                "What's something we do that promotes our wellbeing?",
                "How can we create healthier routines together?",
                "What aspect of health is most important to you for us?",
                "How do we motivate each other to stay healthy?",
                "What healthy activity would you like to try together?",
                "How can we better care for our emotional health?",
                "What's a wellness challenge we could take on together?",
                "How do we maintain balance in our busy lives?"
            ],
            "🎓 Learning + Growth": [
                "What's something new you'd like to learn together?",
                "How do we challenge each other intellectually?",
                "What topic would you love to explore more deeply?",
                "How can we better support each other's education goals?",
                "What's the most interesting thing you've learned recently?",
                "How do we stay curious and keep growing?",
                "What skill would benefit our relationship?",
                "How can we learn from our mistakes better?",
                "What's a subject you'd like me to teach you about?",
                "How do we encourage each other's intellectual growth?",
                "What book or course should we do together?",
                "How can we better learn from other couples?",
                "What's something you've learned about love from our relationship?",
                "How do we stay open to new ideas and perspectives?",
                "What wisdom do you want us to gain together?"
            ],
            "🌈 Emotions + Feelings": [
                "What emotion do you feel most strongly in our relationship?",
                "How can I better understand your emotional needs?",
                "What feeling do you have trouble expressing to me?",
                "How do we create emotional safety for each other?",
                "What emotion do you want to experience more of together?",
                "How can we better process difficult emotions together?",
                "What makes you feel most emotionally connected to me?",
                "How do we handle emotional overwhelm as a couple?",
                "What's your favorite emotional memory of us?",
                "How can we celebrate positive emotions more?",
                "What emotion do you see me struggle with most?",
                "How do we support each other through emotional challenges?",
                "What feeling do you want our relationship to be known for?",
                "How can we better validate each other's emotions?",
                "What emotional goal do you have for our relationship?"
            ],
            "🎪 Traditions + Celebrations": [
                "What tradition from your family would you like us to continue?",
                "How do you want to celebrate our relationship milestones?",
                "What new tradition should we start this year?",
                "What's your favorite way we celebrate special occasions?",
                "How can we make ordinary days feel more special?",
                "What holiday tradition means the most to you?",
                "How do we want to celebrate our anniversary each year?",
                "What's a celebration we should plan together?",
                "How can we better honor important moments?",
                "What tradition would you like to create for our future family?",
                "How do we make celebrations meaningful rather than stressful?",
                "What's your favorite celebration we've had together?",
                "How can we celebrate each other's achievements better?",
                "What seasonal celebration do you look forward to most?",
                "How do we create lasting memories through our celebrations?"
            ],
            "🔮 Future Dreams": [
                "What does your ideal life with me look like in 10 years?",
                "What dream for our future excites you most?",
                "How do you envision us growing old together?",
                "What legacy do you want our love story to have?",
                "What's something you hope never changes about us?",
                "How do you see our relationship evolving?",
                "What future challenge are you most prepared to face with me?",
                "What dream destination would you love to visit together?",
                "How do you want our love to impact future generations?",
                "What's your biggest hope for our relationship?",
                "How do you envision us serving God together in the future?",
                "What future version of ourselves are you most excited about?",
                "What dream would you like us to pursue together?",
                "How do you see us supporting each other in old age?",
                "What future tradition do you want to start now?"
            ],
            "💫 Intimacy + Connection": [
                "What makes you feel most connected to me?",
                "How can we deepen our emotional intimacy?",
                "What's your favorite intimate moment we've shared?",
                "How do we maintain closeness during busy seasons?",
                "What makes you feel most cherished by me?",
                "How can we better prioritize our connection?",
                "What's something that draws you closer to me?",
                "How do we create more meaningful moments together?",
                "What makes our connection unique and special?",
                "How can we better protect our intimacy?",
                "What's your favorite way we connect without words?",
                "How do we maintain romance in our daily life?",
                "What makes you feel most desired and valued?",
                "How can we create more space for deep connection?",
                "What aspect of our intimacy are you most grateful for?"
            ],
            "🎭 Personality + Quirks": [
                "What quirk of mine do you find most endearing?",
                "How do our different personalities complement each other?",
                "What's something unique about me that you love?",
                "How can we better appreciate our differences?",
                "What personality trait of yours has grown since we've been together?",
                "What's your favorite thing about my sense of humor?",
                "How do we balance our different energy levels?",
                "What's something about your personality you want me to understand better?",
                "How do our personalities make us a great team?",
                "What's a quirky habit we've developed together?",
                "How can we better celebrate what makes each of us unique?",
                "What personality trait do you most admire in me?",
                "How do we handle our different approaches to life?",
                "What's something about my personality that surprised you?",
                "How do our individual quirks make our relationship more fun?"
            ],
            "🌺 Romance + Love": [
                "What's the most romantic thing we've done together?",
                "How can we keep romance alive in our daily routine?",
                "What makes you feel most romanced by me?",
                "What's your favorite love story about us?",
                "How do we show love in small, daily ways?",
                "What romantic gesture would mean the world to you?",
                "How has your understanding of love grown through our relationship?",
                "What's your favorite way I express my love for you?",
                "How can we create more romantic moments together?",
                "What makes our love story unique?",
                "How do we keep the butterflies alive in our relationship?",
                "What's your favorite romantic memory of us?",
                "How can we better express our love through actions?",
                "What does true love mean to you in our relationship?",
                "How do we make each other feel like the most important person in the world?"
            ],
            "🙏 Prayer + Worship": [
                "How can we make prayer a bigger part of our daily routine?",
                "What's your favorite way to worship God together?",
                "How has praying together strengthened our relationship?",
                "What's something you'd like us to pray about more?",
                "How do you feel when we pray together?",
                "What's your favorite worship song for us as a couple?",
                "How can we better invite God into our relationship?",
                "What's a prayer request you have for our relationship?",
                "How do we encourage each other's personal prayer life?",
                "What's your favorite way to experience God's presence together?",
                "How can we create more sacred moments in our relationship?",
                "What's something God has taught you through our relationship?",
                "How do we make worship a natural part of our life together?",
                "What's a way we can serve God together through our love?",
                "How can we better align our relationship with God's will?"
            ]
        };

        // 250 unique date night questions
        const dateNightQuestions = [
            "What's your favorite memory of us?",
            "How do you feel most loved by me?",
            "What dream do we share for our future?",
            "What's something new you'd like to try together?",
            "How can we make our relationship even stronger?",
            "What's your favorite thing about our connection?",
            "What adventure would you love to go on with me?",
            "How do we bring out the best in each other?",
            "What tradition would you like us to start?",
            "What makes you most excited about our future?",
            "How do you feel when we pray together?",
            "What's your favorite way we spend quality time?",
            "What's something you admire about my character?",
            "How can we serve God together more?",
            "What's a goal we should pursue as a couple?",
            "What's your favorite thing I do that shows love?",
            "How do you see us growing spiritually together?",
            "What's something you're grateful for about today?",
            "What's a challenge we've overcome that made us stronger?",
            "How do you feel God is blessing our relationship?",
            "What's the most romantic thing we've ever done?",
            "If we could travel anywhere together, where would it be?",
            "What's your favorite thing about my personality?",
            "How do you want to celebrate our next anniversary?",
            "What's something you've learned about love from me?",
            "What's your favorite date we've been on?",
            "How do you see us in 10 years?",
            "What's something that always makes you smile about us?",
            "What's your favorite way I surprise you?",
            "How can we make our home feel more like 'us'?",
            "What's something you want to accomplish together this year?",
            "What's your favorite inside joke we share?",
            "How do you feel when I hold your hand?",
            "What's something you hope never changes about us?",
            "What's your favorite thing we do on lazy Sundays?",
            "How do you want our love story to be remembered?",
            "What's something that makes you proud to be with me?",
            "What's your favorite way we connect without words?",
            "How can we better support each other's dreams?",
            "What's something you want to learn together?",
            "What's your favorite thing about our friendship?",
            "How do you feel most understood by me?",
            "What's something adventurous we should try?",
            "What's your favorite way we show affection?",
            "How can we make ordinary moments more special?",
            "What's something you love about our daily routine?",
            "What's your favorite compliment I've given you?",
            "How do you want to grow old together?",
            "What's something that makes our relationship unique?",
            "What's your favorite way we laugh together?",
            "How can we create more romantic moments?",
            "What's something you're excited to experience with me?",
            "What's your favorite thing about our conversations?",
            "How do you feel when we're cuddled up together?",
            "What's something you want to do more of as a couple?",
            "What's your favorite memory from our first year together?",
            "How can we better celebrate each other?",
            "What's something that makes you feel safe with me?",
            "What's your favorite way we resolve conflicts?",
            "How do you want to serve others together?",
            "What's something you love about our physical connection?",
            "What's your favorite thing we've built together?",
            "How can we make our relationship a priority?",
            "What's something you want to experience for the first time with me?",
            "What's your favorite way I encourage you?",
            "How do you feel when we worship together?",
            "What's something you love about our differences?",
            "What's your favorite tradition we've started?",
            "How can we better communicate our needs?",
            "What's something that makes you feel cherished?",
            "What's your favorite way we spend holidays?",
            "How do you want to impact others through our love?",
            "What's something you love about our intimacy?",
            "What's your favorite thing about our home together?",
            "How can we keep the romance alive long-term?",
            "What's something you want to pray about together?",
            "What's your favorite way we handle stress together?",
            "How do you feel when I tell you I love you?",
            "What's something you want to improve about us?",
            "What's your favorite spontaneous thing we've done?",
            "How can we better show gratitude for each other?",
            "What's something that makes you feel proud of us?",
            "What's your favorite way we support each other?",
            "How do you want to celebrate life's big moments?",
            "What's something you love about our emotional connection?",
            "What's your favorite thing about our future plans?",
            "How can we make our love more Christ-centered?",
            "What's something you want to create together?",
            "What's your favorite way we show respect for each other?",
            "How do you feel when we're planning our future?",
            "What's something you love about our teamwork?",
            "What's your favorite way we make decisions together?",
            "How can we better honor God in our relationship?",
            "What's something you want to explore together?",
            "What's your favorite thing about our chemistry?",
            "How do you want to handle life's challenges together?",
            "What's something you love about our shared values?",
            "What's your favorite way we encourage each other's faith?",
            "How can we make our relationship a testimony?",
            "What's something you want to discover about me?",
            "What's your favorite thing about our partnership?",
            "How do you feel when we're working toward a goal together?",
            "What's something you love about our playfulness?",
            "What's your favorite way we show kindness to each other?",
            "How can we better invest in our relationship?",
            "What's something you want to remember about this season?",
            "What's your favorite thing about our love story?",
            "How do you want to leave a legacy together?",
            "What's something you love about our spiritual connection?",
            "What's your favorite way we comfort each other?",
            "How can we make our relationship more fun?",
            "What's something you want to teach our future children?",
            "What's your favorite thing about our commitment?",
            "How do you feel when we're dreaming together?",
            "What's something you love about our growth together?",
            "What's your favorite way we show patience with each other?",
            "How can we better protect our relationship?",
            "What's something you want to celebrate about us?",
            "What's your favorite thing about our trust?",
            "How do you want to handle disagreements better?",
            "What's something you love about our vulnerability?",
            "What's your favorite way we show forgiveness?",
            "How can we make our love more selfless?",
            "What's something you want to appreciate more about me?",
            "What's your favorite thing about our loyalty?",
            "How do you feel when we're being completely honest?",
            "What's something you love about our dedication?",
            "What's your favorite way we show grace to each other?",
            "How can we better reflect God's love?",
            "What's something you want to admire about our future?",
            "What's your favorite thing about our perseverance?",
            "How do you want to strengthen our bond?",
            "What's something you love about our authenticity?",
            "What's your favorite way we show compassion?",
            "How can we make our relationship more Christ-like?",
            "What's something you want to treasure about us?",
            "What's your favorite thing about our faithfulness?",
            "How do you feel when we're being our true selves?",
            "What's something you love about our generosity toward each other?",
            "What's your favorite way we show humility?",
            "How can we better serve God through our love?",
            "What's something you want to cherish about this moment?",
            "What's your favorite thing about our hope for the future?",
            "How do you want to honor each other better?",
            "What's something you love about our joy together?",
            "What's your favorite way we show wisdom in our choices?",
            "How can we make our relationship a blessing to others?",
            "What's something you want to value more in our relationship?",
            "What's your favorite thing about our peace together?",
            "How do you feel when we're completely content with each other?",
            "What's something you love about our strength as a couple?",
            "What's your favorite way we show courage in our relationship?",
            "How can we better glorify God through our love?",
            "What's something you want to embrace about our journey?",
            "What's your favorite thing about our unity?",
            "How do you want to deepen our spiritual intimacy?",
            "What's something you love about our gentleness with each other?",
            "What's your favorite way we show self-control?",
            "How can we make our love more like Christ's love?",
            "What's something you want to celebrate about our calling?",
            "What's your favorite thing about our goodness toward each other?",
            "How do you feel when we're walking in God's will together?",
            "What's something you love about our meekness?",
            "What's your favorite way we show temperance?",
            "How can we better bear fruit in our relationship?",
            "What's something you want to rejoice about in our love?",
            "What's your favorite thing about our righteousness together?",
            "How do you want to pursue holiness as a couple?",
            "What's something you love about our sanctification together?",
            "What's your favorite way we show reverence for God?",
            "How can we make our relationship more pleasing to God?",
            "What's something you want to worship God for in our relationship?",
            "What's your favorite thing about our obedience to God?",
            "How do you feel when we're seeking God's will together?",
            "What's something you love about our surrender to God?",
            "What's your favorite way we show devotion to each other?",
            "How can we better walk in the Spirit together?",
            "What's something you want to praise God for about us?",
            "What's your favorite thing about our fellowship together?",
            "How do you want to grow in grace as a couple?",
            "What's something you love about our testimony together?",
            "What's your favorite way we show love for God's Word?",
            "How can we better encourage each other spiritually?",
            "What's something you want to thank God for in our relationship?",
            "What's your favorite thing about our ministry together?",
            "How do you feel when we're serving God as one?",
            "What's something you love about our witness to others?",
            "What's your favorite way we show hospitality together?",
            "How can we better use our gifts to serve God?",
            "What's something you want to intercede for in our relationship?",
            "What's your favorite thing about our stewardship together?",
            "How do you want to be more Christ-like in our love?",
            "What's something you love about our discipleship together?",
            "What's your favorite way we show mercy to each other?",
            "How can we better reflect the Gospel in our relationship?",
            "What's something you want to surrender to God about us?",
            "What's your favorite thing about our covenant together?",
            "How do you feel when we're praying for each other?",
            "What's something you love about our mission together?",
            "What's your favorite way we show the love of Christ?",
            "How can we better point others to Jesus through our love?",
            "What's something you want to dedicate to God in our relationship?",
            "What's your favorite thing about our eternal perspective?",
            "How do you want to prepare for eternity together?",
            "What's something you love about our heavenly hope?",
            "What's your favorite way we show we're citizens of heaven?",
            "How can we better live for God's glory in our relationship?",
            "What's something you want to offer to God from our love?",
            "What's your favorite thing about our spiritual warfare together?",
            "How do you feel when we're standing strong in faith together?",
            "What's something you love about our victory in Christ?",
            "What's your favorite way we show we're more than conquerors?",
            "How can we better walk in the freedom Christ gives?",
            "What's something you want to declare about God's goodness in our relationship?",
            "What's your favorite thing about our inheritance in Christ?",
            "How do you want to live out our identity in Christ together?",
            "What's something you love about being co-heirs with Christ?",
            "What's your favorite way we show we're God's masterpiece?",
            "How can we better live as the bride of Christ?",
            "What's something you want to proclaim about God's love through us?",
            "What's your favorite thing about our calling to be holy?",
            "How do you feel when we're reflecting God's character together?",
            "What's something you love about being God's beloved together?",
            "What's your favorite way we show we're fearfully and wonderfully made?",
            "How can we better live as God's chosen people?",
            "What's something you want to magnify about God through our relationship?",
            "What's your favorite thing about our purpose in God's kingdom?",
            "How do you want to advance God's kingdom together?",
            "What's something you love about being ambassadors for Christ?",
            "What's your favorite way we show we're the light of the world?",
            "How can we better be salt and light in our community?",
            "What's something you want to shine for God in our relationship?",
            "What's your favorite thing about our calling to love like Christ?",
            "How do you feel when we're laying down our lives for each other?",
            "What's something you love about our sacrificial love?",
            "What's your favorite way we show agape love?",
            "How can we better love with the love of Christ?",
            "What's something you want to pour out for God in our relationship?",
            "What's your favorite thing about our eternal love story?",
            "How do you want our love to echo throughout eternity?",
            "What's something you love about our forever with God?",
            "What's your favorite way we show our love will never end?",
            "How can we better prepare for our eternal celebration?",
            "What's something you want to anticipate about heaven together?",
            "What's your favorite thing about our hope of glory?",
            "How do you feel when you think about eternity with me and Jesus?",
            "What's something you love about our unending worship together?",
            "What's your favorite way we can glorify God forever?",
            "How can we better live with eternity in view?",
            "What's something you want to look forward to in our eternal home?",
            "What's your favorite thing about our perfect love in heaven?",
            "How do you want to spend our first day in paradise together?",
            "What's something you love about our reunion with Christ?",
            "What's your favorite way we'll worship in God's presence forever?",
            "How can we better prepare our hearts for that glorious day?",
            "What's something you want to celebrate about our eternal joy?",
            "What's your favorite thing about our perfect unity in Christ?",
            "How do you feel about experiencing God's love perfectly together forever?"
        ];

        // Weekly check-in questions
        const weeklyQuestions = [
            {
                q1: "What brought us closer this week?",
                q2: "How can we grow together next week?"
            },
            {
                q1: "What did we learn about each other this week?",
                q2: "What's one thing we want to improve together?"
            },
            {
                q1: "How did we show love to each other this week?",
                q2: "What's our focus for the coming week?"
            },
            {
                q1: "What challenged us this week and how did we handle it?",
                q2: "What are we most excited about for next week?"
            }
        ];

        // Get all questions in order
        function getAllQuestions() {
            const allQuestions = [];
            for (const [category, questions] of Object.entries(questionCategories)) {
                questions.forEach(question => {
                    allQuestions.push({ category, question });
                });
            }
            return allQuestions;
        }

        // Get today's question based on date
        function getTodaysQuestion() {
            const allQuestions = getAllQuestions();
            const startDate = new Date('2024-01-01');
            const today = new Date();
            const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            const questionIndex = daysSinceStart % allQuestions.length;
            return allQuestions[questionIndex];
        }

        // Check if it's a weekly check-in day (every 7 days)
        function isWeeklyCheckinDay() {
            const startDate = new Date('2024-01-01'); // Monday
            const today = new Date();
            const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            return daysSinceStart % 7 === 0; // Every 7 days
        }

        // Get weekly check-in questions
        function getWeeklyQuestions() {
            const startDate = new Date('2024-01-01');
            const today = new Date();
            const weeksSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24 * 7));
            const questionIndex = weeksSinceStart % weeklyQuestions.length;
            return weeklyQuestions[questionIndex];
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            currentTab = tabName;
            
            // Load content based on tab
            if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'datenight') {
                drawNewCards();
            }
        }

        // User dropdown
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('userDropdown');
            const userInfo = document.querySelector('.user-info');
            if (!userInfo.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Authentication functions
        function toggleAuthMode() {
            isSignUp = !isSignUp;
            const submitBtn = document.getElementById('authSubmit');
            const createBtn = document.getElementById('createAccountBtn');
            const forgotBtn = document.getElementById('forgotPasswordBtn');
            
            if (isSignUp) {
                submitBtn.textContent = 'Create Account';
                createBtn.textContent = 'Back to Sign In';
                forgotBtn.style.display = 'none';
            } else {
                submitBtn.textContent = 'Sign In';
                createBtn.textContent = 'Create Account';
                forgotBtn.style.display = 'inline-block';
            }
        }

        function openForgotPassword() {
            document.getElementById('forgotPasswordModal').classList.add('show');
        }

        function closeForgotPassword() {
            document.getElementById('forgotPasswordModal').classList.remove('show');
        }

        async function handleForgotPassword(email) {
            try {
                await auth.sendPasswordResetEmail(email);
                showNotification('Password reset email sent! Check your inbox 📧');
                closeForgotPassword();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function handleAuth(email, password) {
            try {
                let userCredential;
                if (isSignUp) {
                    userCredential = await auth.createUserWithEmailAndPassword(email, password);
                } else {
                    userCredential = await auth.signInWithEmailAndPassword(email, password);
                }
                
                currentUser = userCredential.user;
                await initializeUserData();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function initializeUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (!userDoc.exists) {
                    const coupleCode = generateCoupleCode();
                    
                    try {
                        await db.collection('users').doc(currentUser.uid).set({
                            email: currentUser.email,
                            displayName: currentUser.email.split('@')[0],
                            profilePicture: null,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            coupleId: null,
                            coupleCode: coupleCode
                        });
                    } catch (createError) {
                        console.error('Error creating user document:', createError);
                        showMainApp();
                        return;
                    }
                }
                
                await loadUserProfile();
                
                const userData = userDoc.exists ? userDoc.data() : await (await db.collection('users').doc(currentUser.uid).get()).data();
                if (!userData || !userData.coupleId) {
                    showCoupleCodeScreen();
                } else {
                    currentCoupleId = userData.coupleId;
                    setupCoupleSync();
                    showMainApp();
                }
            } catch (error) {
                console.error('Database permission error:', error);
                showNotification('Using offline mode - some features may be limited', 'warning');
                showMainApp();
            }
        }

        async function loadUserProfile() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                if (userData) {
                    const displayName = userData.displayName || currentUser.email.split('@')[0];
                    document.getElementById('navDisplayName').textContent = displayName;
                    document.getElementById('displayNameInput').value = displayName;
                    
                    if (userData.anniversary) {
                        document.getElementById('anniversaryInput').value = userData.anniversary;
                    }
                    
                    // Load couple code in settings
                    if (userData.coupleCode) {
                        document.getElementById('settingsCoupleCode').value = userData.coupleCode;
                    }
                    
                    const initials = displayName.charAt(0).toUpperCase();
                    document.getElementById('navProfileInitials').textContent = initials;
                    
                    if (userData.profilePicture) {
                        const navProfilePic = document.getElementById('navProfilePic');
                        navProfilePic.innerHTML = `<img src="${userData.profilePicture}" alt="Profile">`;
                    }
                    
                    // Update partner avatars with profile pictures
                    await updatePartnerAvatars();
                    
                    currentCoupleId = userData.coupleId;
                    await loadCoupleData();
                } else {
                    const localProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    const displayName = localProfile.displayName || currentUser.email.split('@')[0];
                    document.getElementById('navDisplayName').textContent = displayName;
                    document.getElementById('displayNameInput').value = displayName;
                    
                    const initials = displayName.charAt(0).toUpperCase();
                    document.getElementById('navProfileInitials').textContent = initials;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                const localProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                const displayName = localProfile.displayName || currentUser.email.split('@')[0];
                document.getElementById('navDisplayName').textContent = displayName;
                document.getElementById('displayNameInput').value = displayName;
                
                const initials = displayName.charAt(0).toUpperCase();
                document.getElementById('navProfileInitials').textContent = initials;
            }
        }

        async function loadCoupleData() {
            if (!currentCoupleId) return;
            
            try {
                const coupleDoc = await db.collection('couples').doc(currentCoupleId).get();
                if (coupleDoc.exists) {
                    const coupleData = coupleDoc.data();
                    
                    if (coupleData.partner1Id === currentUser.uid) {
                        document.getElementById('partnerName1').textContent = 'You';
                        if (coupleData.partner2Name) {
                            document.getElementById('partnerName2').textContent = coupleData.partner2Name;
                        }
                    } else {
                        document.getElementById('partnerName2').textContent = 'You';
                        if (coupleData.partner1Name) {
                            document.getElementById('partnerName1').textContent = coupleData.partner1Name;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading couple data:', error);
            }
        }

        async function updatePartnerAvatars() {
            if (!currentCoupleId) return;
            
            try {
                const coupleDoc = await db.collection('couples').doc(currentCoupleId).get();
                if (coupleDoc.exists) {
                    const coupleData = coupleDoc.data();
                    
                    // Get partner user documents to load profile pictures
                    const partner1Doc = await db.collection('users').doc(coupleData.partner1Id).get();
                    const partner2Doc = await db.collection('users').doc(coupleData.partner2Id).get();
                    
                    const partner1Data = partner1Doc.data();
                    const partner2Data = partner2Doc.data();
                    
                    // Update avatars with profile pictures
                    if (partner1Data?.profilePicture) {
                        const avatar1 = document.getElementById('partnerAvatar1');
                        avatar1.innerHTML = `<img src="${partner1Data.profilePicture}" alt="Profile">`;
                    }
                    
                    if (partner2Data?.profilePicture) {
                        const avatar2 = document.getElementById('partnerAvatar2');
                        avatar2.innerHTML = `<img src="${partner2Data.profilePicture}" alt="Profile">`;
                    }
                }
            } catch (error) {
                console.error('Error updating partner avatars:', error);
            }
        }

        function showMainApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('coupleCodeScreen').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            initializeApp();
        }

        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'block';
            document.getElementById('coupleCodeScreen').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showCoupleCodeScreen() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('coupleCodeScreen').style.display = 'block';
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
            
            loadCoupleCode();
        }

        function generateCoupleCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function loadCoupleCode() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                if (userData && userData.coupleCode) {
                    document.getElementById('yourCoupleCode').value = userData.coupleCode;
                }
            } catch (error) {
                console.error('Error loading couple code:', error);
            }
        }

        function copyCode() {
            const codeInput = document.getElementById('yourCoupleCode');
            codeInput.select();
            document.execCommand('copy');
            showNotification('Code copied! Share it with your partner 💕');
        }

        async function connectWithPartner(partnerCode) {
            if (!currentUser || !partnerCode) return;
            
            try {
                const partnerQuery = await db.collection('users')
                    .where('coupleCode', '==', partnerCode.toUpperCase())
                    .where('coupleId', '==', null)
                    .limit(1)
                    .get();
                
                if (partnerQuery.empty) {
                    showNotification('Invalid code or partner already connected', 'error');
                    return;
                }
                
                const partnerDoc = partnerQuery.docs[0];
                const partnerId = partnerDoc.id;
                const partnerData = partnerDoc.data();
                
                if (partnerId === currentUser.uid) {
                    showNotification('You cannot connect to yourself!', 'error');
                    return;
                }
                
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                const coupleRef = db.collection('couples').doc();
                currentCoupleId = coupleRef.id;
                
                await coupleRef.set({
                    partner1Id: currentUser.uid,
                    partner1Name: userData.displayName,
                    partner1Email: userData.email,
                    partner1Code: userData.coupleCode,
                    partner2Id: partnerId,
                    partner2Name: partnerData.displayName,
                    partner2Email: partnerData.email,
                    partner2Code: partnerData.coupleCode,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    currentStreak: 0
                });
                
                await db.collection('users').doc(currentUser.uid).update({
                    coupleId: currentCoupleId
                });
                await db.collection('users').doc(partnerId).update({
                    coupleId: currentCoupleId
                });
                
                setupCoupleSync();
                showMainApp();
                showNotification('Connected with your partner! 💕');
            } catch (error) {
                console.error('Error connecting with partner:', error);
                showNotification('Error connecting with partner', 'error');
            }
        }

        function skipCoupleCode() {
            showMainApp();
            showNotification('You can connect with your partner later in settings! 💭');
        }

        async function signOut() {
            try {
                await auth.signOut();
                currentUser = null;
                currentCoupleId = null;
                showAuthScreen();
                closeSettings();
            } catch (error) {
                showNotification('Error signing out', 'error');
            }
        }

        // Initialize the app
        function initializeApp() {
            // Set today's date
            const today = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('todaysDate').textContent = today.toLocaleDateString('en-US', options);
            
            // Set today's question
            const todaysQuestion = getTodaysQuestion();
            document.getElementById('todaysCategory').textContent = todaysQuestion.category;
            document.getElementById('todaysQuestion').textContent = todaysQuestion.question;
            
            // Check for weekly check-in
            if (isWeeklyCheckinDay()) {
                const weeklyQ = getWeeklyQuestions();
                document.getElementById('weeklyCheckin').style.display = 'block';
                document.querySelector('#weeklyCheckin .checkin-card:first-child h4').textContent = weeklyQ.q1;
                document.querySelector('#weeklyCheckin .checkin-card:last-child h4').textContent = weeklyQ.q2;
                loadWeeklyCheckin();
            }
            
            // Load relationship stats
            loadRelationshipStats();
            
            // Load saved entries
            loadSavedEntries();
            
            // Initialize history filters
            initializeHistoryFilters();
            
            // Initialize date night cards
            loadDateNightProgress();
            drawNewCards();
        }

        // Load and calculate relationship stats
        async function loadRelationshipStats() {
            if (!currentUser) return;
            
            try {
                // Calculate days together from anniversary date
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                if (userData && userData.anniversary) {
                    const anniversaryDate = new Date(userData.anniversary);
                    const today = new Date();
                    // Set time to midnight to get accurate day count
                    anniversaryDate.setHours(0, 0, 0, 0);
                    today.setHours(0, 0, 0, 0);
                    const daysTogether = Math.floor((today - anniversaryDate) / (1000 * 60 * 60 * 24));
                    document.getElementById('daysTogether').textContent = daysTogether >= 0 ? daysTogether : 0;
                } else {
                    // Fallback: calculate from account creation or couple connection
                    const createdAt = userData?.createdAt?.toDate() || new Date();
                    const today = new Date();
                    createdAt.setHours(0, 0, 0, 0);
                    today.setHours(0, 0, 0, 0);
                    const daysTogether = Math.floor((today - createdAt) / (1000 * 60 * 60 * 24));
                    document.getElementById('daysTogether').textContent = daysTogether >= 0 ? daysTogether : 0;
                }
                
                // Calculate streak and total entries
                if (currentCoupleId) {
                    const coupleDoc = await db.collection('couples').doc(currentCoupleId).get();
                    const coupleData = coupleDoc.data();
                    
                    // Get current streak from couple data
                    document.getElementById('currentStreak').textContent = coupleData?.currentStreak || 0;
                    
                    // Calculate total entries
                    const entriesSnapshot = await db.collection('couples').doc(currentCoupleId)
                        .collection('entries')
                        .where('userId', '==', currentUser.uid)
                        .get();
                    
                    document.getElementById('totalEntries').textContent = entriesSnapshot.size;
                    
                    // Update streak based on recent activity
                    await updateStreak();
                } else {
                    // Calculate from localStorage
                    let totalEntries = 0;
                    [1, 2].forEach(partner => {
                        const storageKey = `journal_partner${partner}`;
                        const entries = JSON.parse(localStorage.getItem(storageKey) || '[]');
                        totalEntries += entries.length;
                    });
                    
                    // Add weekly check-ins
                    const weeklyEntries = JSON.parse(localStorage.getItem('weekly_checkins') || '[]');
                    totalEntries += weeklyEntries.length;
                    
                    document.getElementById('totalEntries').textContent = totalEntries;
                    
                    // Calculate streak from localStorage
                    const streak = calculateLocalStreak();
                    document.getElementById('currentStreak').textContent = streak;
                }
            } catch (error) {
                console.error('Error loading relationship stats:', error);
                // Set default values
                document.getElementById('daysTogether').textContent = '0';
                document.getElementById('currentStreak').textContent = '0';
                document.getElementById('totalEntries').textContent = '0';
            }
        }

        // Update streak based on recent journal activity
        async function updateStreak() {
            if (!currentCoupleId || !currentUser) return;
            
            try {
                const today = new Date();
                const dates = [];
                
                // Get last 30 days of entries
                for (let i = 0; i < 30; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    dates.push(date.toDateString());
                }
                
                const entriesSnapshot = await db.collection('couples').doc(currentCoupleId)
                    .collection('entries')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                const entryDates = new Set();
                entriesSnapshot.forEach(doc => {
                    entryDates.add(doc.data().date);
                });
                
                // Calculate current streak
                let streak = 0;
                for (const date of dates) {
                    if (entryDates.has(date)) {
                        streak++;
                    } else {
                        break;
                    }
                }
                
                // Update couple document with new streak
                await db.collection('couples').doc(currentCoupleId).update({
                    currentStreak: streak
                });
                
                document.getElementById('currentStreak').textContent = streak;
            } catch (error) {
                console.error('Error updating streak:', error);
            }
        }

        // Calculate streak from localStorage
        function calculateLocalStreak() {
            const today = new Date();
            let streak = 0;
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateString = date.toDateString();
                
                let hasEntry = false;
                
                // Check journal entries
                [1, 2].forEach(partner => {
                    const storageKey = `journal_partner${partner}`;
                    const entries = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    if (entries.some(entry => entry.date === dateString)) {
                        hasEntry = true;
                    }
                });
                
                // Check weekly check-ins
                const weeklyEntries = JSON.parse(localStorage.getItem('weekly_checkins') || '[]');
                if (weeklyEntries.some(entry => entry.date === dateString)) {
                    hasEntry = true;
                }
                
                if (hasEntry) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // Profile picture upload
        async function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (!file || !currentUser) return;
            
            // Validate file type and size
            if (!file.type.startsWith('image/')) {
                showNotification('Please select an image file', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showNotification('Image must be smaller than 5MB', 'error');
                return;
            }
            
            try {
                // Convert to base64 for storage
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Image = e.target.result;
                    
                    try {
                        // Update user document with profile picture
                        await db.collection('users').doc(currentUser.uid).update({
                            profilePicture: base64Image
                        });
                        
                        // Update UI immediately
                        const navProfilePic = document.getElementById('navProfilePic');
                        navProfilePic.innerHTML = `<img src="${base64Image}" alt="Profile">`;
                        
                        showNotification('Profile picture updated! ✨');
                    } catch (error) {
                        console.error('Error saving profile picture:', error);
                        // Save to localStorage as fallback
                        const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                        userProfile.profilePicture = base64Image;
                        localStorage.setItem('userProfile', JSON.stringify(userProfile));
                        
                        const navProfilePic = document.getElementById('navProfilePic');
                        navProfilePic.innerHTML = `<img src="${base64Image}" alt="Profile">`;
                        
                        showNotification('Profile picture updated! ✨');
                    }
                };
                reader.readAsDataURL(file);
            } catch (error) {
                showNotification('Error uploading image', 'error');
            }
        }

        // Settings functions
        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
            document.getElementById('userDropdown').classList.remove('show');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        async function saveSettings() {
            if (!currentUser) return;
            
            const displayName = document.getElementById('displayNameInput').value.trim();
            const anniversary = document.getElementById('anniversaryInput').value;
            
            if (!displayName) {
                showNotification('Please enter a display name', 'error');
                return;
            }
            
            try {
                const updateData = { displayName: displayName };
                if (anniversary) {
                    updateData.anniversary = anniversary;
                }
                
                await db.collection('users').doc(currentUser.uid).update(updateData);
                
                await loadUserProfile();
                closeSettings();
                showNotification('Settings saved! ✨');
            } catch (error) {
                showNotification('Error saving settings', 'error');
            }
        }

        function copySettingsCode() {
            const codeInput = document.getElementById('settingsCoupleCode');
            codeInput.select();
            document.execCommand('copy');
            showNotification('Couple code copied! 💕');
        }

        async function connectPartnerFromSettings() {
            const partnerCode = document.getElementById('partnerCodeInput').value.trim();
            if (!partnerCode) {
                showNotification('Please enter a partner code', 'error');
                return;
            }
            
            await connectWithPartner(partnerCode);
            document.getElementById('partnerCodeInput').value = '';
        }

        // Save journal entry
        async function saveEntry(partner) {
            if (!currentUser) return;
            
            const textarea = document.getElementById(`journal${partner}`);
            const entry = textarea.value.trim();
            
            if (!entry) {
                showNotification('Please write something before saving! 💭', 'error');
                return;
            }

            const today = new Date().toDateString();
            const todaysQuestion = getTodaysQuestion();
            
            const entryData = {
                date: today,
                question: todaysQuestion.question,
                category: todaysQuestion.category,
                entry: entry,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userId: currentUser.uid,
                partner: partner
            };

            try {
                const saveBtn = document.getElementById(`saveBtn${partner}`);
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                
                if (currentCoupleId) {
                    await db.collection('couples').doc(currentCoupleId)
                        .collection('entries').doc(`${today}-${currentUser.uid}-${partner}`).set(entryData);
                } else {
                    const storageKey = `journal_partner${partner}`;
                    let entries = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    entries = entries.filter(e => e.date !== today);
                    entries.push(entryData);
                    localStorage.setItem(storageKey, JSON.stringify(entries));
                }
                
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Entry';
                showNotification('Entry saved! 💕');
                
                // Update stats after saving
                loadRelationshipStats();
            } catch (error) {
                const saveBtn = document.getElementById(`saveBtn${partner}`);
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Entry';
                showNotification('Error saving entry', 'error');
            }
        }

        // Save weekly check-in
        async function saveCheckin(questionNum) {
            if (!currentUser) return;
            
            const textarea = document.getElementById(`checkinQ${questionNum}`);
            const entry = textarea.value.trim();
            
            if (!entry) {
                showNotification('Please write something before saving! 💭', 'error');
                return;
            }

            const today = new Date().toDateString();
            const weeklyQ = getWeeklyQuestions();
            const question = questionNum === 1 ? weeklyQ.q1 : weeklyQ.q2;
            
            const entryData = {
                date: today,
                question: question,
                category: '💕 Weekly Check-in',
                entry: entry,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userId: currentUser.uid,
                type: 'weekly-checkin',
                questionNum: questionNum
            };

            try {
                if (currentCoupleId) {
                    await db.collection('couples').doc(currentCoupleId)
                        .collection('entries').doc(`${today}-${currentUser.uid}-checkin-${questionNum}`).set(entryData);
                } else {
                    const storageKey = 'weekly_checkins';
                    let entries = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    entries = entries.filter(e => !(e.date === today && e.questionNum === questionNum));
                    entries.push(entryData);
                    localStorage.setItem(storageKey, JSON.stringify(entries));
                }
                
                showNotification('Check-in saved! 💕');
            } catch (error) {
                showNotification('Error saving check-in', 'error');
            }
        }

        // Load saved entries for today
        async function loadSavedEntries() {
            if (!currentUser) return;
            
            const today = new Date().toDateString();
            
            try {
                if (currentCoupleId) {
                    const entriesSnapshot = await db.collection('couples').doc(currentCoupleId)
                        .collection('entries')
                        .where('date', '==', today)
                        .where('userId', '==', currentUser.uid)
                        .get();
                    
                    entriesSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.type === 'weekly-checkin') {
                            const textarea = document.getElementById(`checkinQ${data.questionNum}`);
                            if (textarea) {
                                textarea.value = data.entry;
                            }
                        } else {
                            const textarea = document.getElementById(`journal${data.partner}`);
                            if (textarea) {
                                textarea.value = data.entry;
                            }
                        }
                    });
                } else {
                    [1, 2].forEach(partner => {
                        const storageKey = `journal_partner${partner}`;
                        const entries = JSON.parse(localStorage.getItem(storageKey) || '[]');
                        const todayEntry = entries.find(e => e.date === today);
                        
                        if (todayEntry) {
                            document.getElementById(`journal${partner}`).value = todayEntry.entry;
                        }
                    });
                    
                    // Load weekly check-ins
                    const weeklyEntries = JSON.parse(localStorage.getItem('weekly_checkins') || '[]');
                    weeklyEntries.forEach(entry => {
                        if (entry.date === today) {
                            const textarea = document.getElementById(`checkinQ${entry.questionNum}`);
                            if (textarea) {
                                textarea.value = entry.entry;
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading entries:', error);
            }
        }

        // Load weekly check-in entries
        async function loadWeeklyCheckin() {
            if (!currentUser) return;
            
            const today = new Date().toDateString();
            
            try {
                if (currentCoupleId) {
                    const entriesSnapshot = await db.collection('couples').doc(currentCoupleId)
                        .collection('entries')
                        .where('date', '==', today)
                        .where('userId', '==', currentUser.uid)
                        .where('type', '==', 'weekly-checkin')
                        .get();
                    
                    entriesSnapshot.forEach(doc => {
                        const data = doc.data();
                        const textarea = document.getElementById(`checkinQ${data.questionNum}`);
                        if (textarea) {
                            textarea.value = data.entry;
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading weekly check-in:', error);
            }
        }

        // History functions
        function initializeHistoryFilters() {
            const monthFilter = document.getElementById('monthFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            
            // Populate month filter
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                monthFilter.appendChild(option);
            });
            
            // Populate category filter
            Object.keys(questionCategories).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
            
            // Add weekly check-in category
            const weeklyOption = document.createElement('option');
            weeklyOption.value = '💕 Weekly Check-in';
            weeklyOption.textContent = '💕 Weekly Check-in';
            categoryFilter.appendChild(weeklyOption);
        }

        async function loadHistory() {
            if (!currentUser) return;
            
            const historyGrid = document.getElementById('historyGrid');
            historyGrid.innerHTML = '<p style="text-align: center; color: #6c757d;">Loading your reflection history...</p>';
            
            try {
                let allEntries = [];
                
                if (currentCoupleId) {
                    const entriesSnapshot = await db.collection('couples').doc(currentCoupleId)
                        .collection('entries')
                        .where('userId', '==', currentUser.uid)
                        .orderBy('timestamp', 'desc')
                        .limit(50)
                        .get();
                    
                    entriesSnapshot.forEach(doc => {
                        allEntries.push(doc.data());
                    });
                } else {
                    // Load from localStorage
                    [1, 2].forEach(partner => {
                        const storageKey = `journal_partner${partner}`;
                        const entries = JSON.parse(localStorage.getItem(storageKey) || '[]');
                        allEntries = allEntries.concat(entries);
                    });
                    
                    // Load weekly check-ins
                    const weeklyEntries = JSON.parse(localStorage.getItem('weekly_checkins') || '[]');
                    allEntries = allEntries.concat(weeklyEntries);
                    
                    // Sort by date (newest first)
                    allEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
                }
                
                displayHistory(allEntries);
            } catch (error) {
                console.error('Error loading history:', error);
                historyGrid.innerHTML = '<p style="text-align: center; color: #e53e3e;">Error loading history</p>';
            }
        }

        function displayHistory(entries) {
            const historyGrid = document.getElementById('historyGrid');
            
            if (entries.length === 0) {
                historyGrid.innerHTML = '<p style="text-align: center; color: #6c757d;">No entries found. Start journaling to see your reflection history! 💭</p>';
                return;
            }
            
            historyGrid.innerHTML = entries.map(entry => `
                <div class="history-entry">
                    <div class="history-entry-header">
                        <span class="history-date">${new Date(entry.date).toLocaleDateString('en-US', { 
                            weekday: 'short', 
                            month: 'short', 
                            day: 'numeric' 
                        })}</span>
                        <span class="history-category">${entry.category}</span>
                    </div>
                    <div class="history-question">${entry.question}</div>
                    <div class="history-response">${entry.entry}</div>
                </div>
            `).join('');
        }

        function filterHistory() {
            const monthFilter = document.getElementById('monthFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            // This would filter the loaded entries - for now, reload with filters
            loadHistory();
        }

        // Current date night question index
        let currentDateNightIndex = 0;

        // Draw new date night cards - now shows one question at a time
        function drawNewCards() {
            // Get next question in sequence to avoid duplicates
            const question = dateNightQuestions[currentDateNightIndex];
            
            // Update all three cards to show the same question for visual effect
            document.getElementById('dateCard1').textContent = question;
            document.getElementById('dateCard2').textContent = question;
            document.getElementById('dateCard3').textContent = question;
            
            // Move to next question, loop back to start when we reach the end
            currentDateNightIndex = (currentDateNightIndex + 1) % dateNightQuestions.length;
            
            // Save progress to localStorage
            localStorage.setItem('dateNightIndex', currentDateNightIndex.toString());
        }

        // Load saved date night progress
        function loadDateNightProgress() {
            const savedIndex = localStorage.getItem('dateNightIndex');
            if (savedIndex) {
                currentDateNightIndex = parseInt(savedIndex);
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Auth form submission
            document.getElementById('authForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                handleAuth(email, password);
            });

            // Auth button listeners
            document.getElementById('createAccountBtn').addEventListener('click', toggleAuthMode);
            document.getElementById('forgotPasswordBtn').addEventListener('click', openForgotPassword);

            // Couple code form submission
            document.getElementById('coupleCodeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const partnerCode = document.getElementById('partnerCode').value.trim();
                if (partnerCode) {
                    connectWithPartner(partnerCode);
                }
            });

            // Forgot password form submission
            document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('resetEmail').value;
                handleForgotPassword(email);
            });

            // Close modals when clicking outside
            document.getElementById('settingsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSettings();
                }
            });

            document.getElementById('forgotPasswordModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeForgotPassword();
                }
            });

            // Firebase auth state listener
            auth.onAuthStateChanged(async function(user) {
                if (user) {
                    currentUser = user;
                    document.getElementById('loadingScreen').style.display = 'block';
                    await initializeUserData();
                } else {
                    currentUser = null;
                    currentCoupleId = null;
                    showAuthScreen();
                }
            });
        });

        // Real-time sync for couple data
        function setupCoupleSync() {
            if (!currentCoupleId) return;

            db.collection('couples').doc(currentCoupleId).onSnapshot(doc => {
                if (doc.exists) {
                    const coupleData = doc.data();
                    updatePartnerInfo(coupleData);
                }
            });

            db.collection('couples').doc(currentCoupleId)
                .collection('entries')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added' || change.type === 'modified') {
                            const data = change.doc.data();
                            if (data.userId !== currentUser.uid) {
                                updatePartnerEntry(data);
                            }
                        }
                    });
                });
        }

        function updatePartnerInfo(coupleData) {
            const isPartner1 = coupleData.partner1Id === currentUser.uid;
            
            if (isPartner1) {
                document.getElementById('partnerName1').textContent = 'You';
                document.getElementById('partnerName2').textContent = coupleData.partner2Name || 'Partner';
                
                const initials2 = (coupleData.partner2Name || 'P').charAt(0).toUpperCase();
                document.getElementById('partnerInitials2').textContent = initials2;
            } else {
                document.getElementById('partnerName2').textContent = 'You';
                document.getElementById('partnerName1').textContent = coupleData.partner1Name || 'Partner';
                
                const initials1 = (coupleData.partner1Name || 'P').charAt(0).toUpperCase();
                document.getElementById('partnerInitials1').textContent = initials1;
            }
        }

        function updatePartnerEntry(entryData) {
            const partnerCard = entryData.partner === 1 ? 
                document.querySelector('.journal-card:first-child') : 
                document.querySelector('.journal-card:last-child');
            
            if (partnerCard && entryData.date === new Date().toDateString()) {
                partnerCard.style.borderLeft = '4px solid #48bb78';
                setTimeout(() => {
                    partnerCard.style.borderLeft = '1px solid #f0f0f0';
                }, 3000);
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f2ed7af030d883',t:'MTc2MDU2OTE3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
