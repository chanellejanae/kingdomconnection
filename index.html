<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kingdom Connection</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyA3jL36hYZBmQsjuI02VY8FfNRvRGuTvKk",
            authDomain: "kingdomconnection-ac1cd.firebaseapp.com",
            projectId: "kingdomconnection-ac1cd",
            storageBucket: "kingdomconnection-ac1cd.firebasestorage.app",
            messagingSenderId: ". ",
            appId: "1:. :web:798bed278e7104fe153cae",
            measurementId: "G-BX9X4ZXCXX"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseModules = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut,
            doc,
            setDoc,
            getDoc,
            onSnapshot,
            updateDoc,
            collection,
            query,
            where,
            getDocs
        };
    </script>
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIktpbmdkb20gQ29ubmVjdGlvbiIsCiAgInNob3J0X25hbWUiOiAiS2luZ2RvbSIsCiAgImRlc2NyaXB0aW9uIjogIkRlZXBlbiB5b3VyIHJlbGF0aW9uc2hpcCB0aHJvdWdoIG1lYW5pbmdmdWwgY29udmVyc2F0aW9ucyBhbmQgc2hhcmVkIGZhaXRoIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmYWZhZmEiLAogICJ0aGVtZV9jb2xvciI6ICIjNjY3ZWVhIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lnZG1sbGQwSnZlRDBpTUNBd0lERXlPQ0F4TWpnaUlIaHRiRzV6UFNKb2RIUndPaTh2ZDNkM0xuY3pMbTl5Wnk4eU1EQXdMM04yWnlJK1BHUmxabk0rUEhkcFpHVjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lnYVdROUlqQWlMejQ4TDJSbFpuTStQR2RzYVc1bFlYSkhabUZrYVdWdWRDQnBaRDBpWjNKaFpHbGxiblFpUGp4emRHOXdJRzltWm5ObGREMGlNQ1VpSUhOMGIzQXRZMjlzYjNJOUlpTTJOamRsWldFaUx6NDhjM1J2Y0NCdlptWnpaWFE5SWpFd01DVWlJSE4wYjNBdFkyOXNiM0k5SWlNM05qUmlZVElpTHo0OEwyZHNhVzVsWVhKSFptRmthV1Z1ZEQ0OGNtVmpkQ0IzYVdSMGFEMGlPREFpSUdobGFXZG9kRDBpT0RBaUlIZzlJakkwSWlCNVBTSXlOQ0lnY25nOUlqSXdJaUJtYVd4c1BTSjFjbXdvSTJkeVlXUnBaVzUwS1NJdkBqeDBaWGgwSUhnOUlqWTBJaUI1UFNJMk5DSWdabWxzYkQwaWQyaHBkR1VpSUdadmJuUXRjMmw2WlQwaU5EQnFlQ0lnWm05dWRDMTNaV2xuYUhROUlqWXdNQ0lnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJK01qVXVNVHd2ZEdWNGRENDhMM04yWno0PSIsCiAgICAgICJzaXplcyI6ICIxMjh4MTI4IiwKIAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU5URXlJaUJvWldsbmFIUTlJalV4TWlJZ2RtbGxkMEp2ZUQwaU1DQXdJRFV4TWlBMU1USWlJSGh0Ykc1elBTSm9kSFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3TDNOMlp5SStQR1JsWm5NK1BIZHBaSFJvUFNJMU1USWlJR2hsYVdkb2REMGlOVEV5SWlCcFpEMGlNQ0lnTHo0OEwyUmxabk0rUEdkc2FXNWxZWEpIWm1Ga2FXVnVkQ0JwWkQwaVozSmhaR2xsYm5RaVBqeHpkRzl3SUc5bVpuTmxkRDBpTUNVaUlITjBiM0F0WTI5c2IzSTlJaU0yTmpkbFpXRWlMejQ4YzNSdmNDQnZabVp6WlhROUlqRXdNQ1VpSUhOMGIzQXRZMjlzYjNJOUlpTTNOalJpWVRJaUx6NDhMMmRzYVc1bFlYSkhaV0ZrYVdWdWRENDhjbVZqZENCM2FXUjBhRDBpTXpJd0lpQm9aV2xuYUhROUlqTXlNQ0lnZUQwaU9UWWlJSGs5SWprMklpQnllRDBpT0RBaUlHWnBiR3c5SW5WeWJDZ2paMkpoWkdsbGJuUXBJaTgrUEhSbGVIUWdlRDBpTWpVMklpQjVQU0l5TlRZaUlHWnBiR3c5SW5kb2FYUmxJaUJtYjI1MExYTnBlbVU5SWpFMk1IQjRJaUJtYjI1MExYZGxhV2RvZEQwaU5qQXdJaUIwWlhoMExXRnVZMmh2Y2owaWJXbGtaR3hsUGpFd01TNDJQQzkwWlhoMFBqd3ZjM1puUGc9PSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
    
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Kingdom Connection">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/chanellejanae/kingdomconnection/main/logo.png">
    
    <!-- Standard favicon -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/chanellejanae/kingdomconnection/main/logo.png">
    
    <!-- Android Chrome -->
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #fafafa;
            min-height: 100%;
            color: #1a1a1a;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        html {
            height: 100%;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: #ffffff;
            padding: 40px 30px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #f0f0f0;
            position: relative;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            overflow: hidden;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
        }

        .header h1 {
            color: #1a1a1a;
            margin: 0 0 12px 0;
            font-size: 2.25rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        .header p {
            color: #6b7280;
            font-size: 1rem;
            margin: 0;
            font-weight: 400;
        }

        .mode-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            padding: 20px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: #374151;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            min-width: 200px;
        }

        .mode-btn:hover {
            border-color: #d1d5db;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .mode-btn.active {
            background: #1a1a1a;
            color: #ffffff;
            border-color: #1a1a1a;
        }

        .btn {
            background: #1a1a1a;
            color: #ffffff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            background: #374151;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background: #ffffff;
            color: #374151;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .hidden {
            display: none;
        }

        .login-container {
            max-width: 400px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #f0f0f0;
            text-align: center;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.875rem;
            color: #1a1a1a;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #9ca3af;
            box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.1);
        }

        .profile-pic-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .profile-pic-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: #9ca3af;
            overflow: hidden;
        }

        .profile-pic-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            background: #f9fafb;
            color: #374151;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .file-input-label:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .user-profile {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #ffffff;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #f0f0f0;
            z-index: 1000;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            color: #9ca3af;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            color: #374151;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .logout-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 0.75rem;
            padding: 4px 8px;
            margin-left: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            color: #374151;
            background: #f9fafb;
        }

        .connection-status {
            background: #ffffff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #f0f0f0;
        }

        .connection-code {
            background: #1a1a1a;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: 2px;
            margin: 15px 0;
            display: inline-block;
            font-family: 'Inter', monospace;
        }

        .journal-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .journal-header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .journal-header h2 {
            color: #4a5568;
            margin: 0 0 10px 0;
            font-size: 2em;
            font-weight: 400;
        }

        .journal-header p {
            color: #718096;
            margin: 0;
            font-size: 1.1em;
        }

        .journal-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #f3f4f6;
        }

        .journal-card h3 {
            color: #1a1a1a;
            margin: 0 0 16px 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .question-category-badge {
            display: inline-block;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 15px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        .daily-question {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 15px;
            font-style: italic;
        }

        .reflection-areas {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .partner-reflection {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #f3f4f6;
        }

        .partner-reflection h4 {
            color: #374151;
            margin: 0 0 15px 0;
            font-size: 1rem;
            font-weight: 500;
        }

        .partner-reflection textarea {
            width: 100%;
            min-height: 120px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 0.875rem;
            color: #1a1a1a;
            resize: vertical;
            box-sizing: border-box;
            transition: all 0.2s ease;
            line-height: 1.5;
        }

        .partner-reflection textarea:focus {
            outline: none;
            border-color: #9ca3af;
            box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.1);
        }

        .partner-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .partner-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: #9ca3af;
            overflow: hidden;
            flex-shrink: 0;
        }

        .partner-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .partner-info h4 {
            margin: 0;
            color: #374151;
            font-size: 1rem;
            font-weight: 500;
        }

        .journal-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .date-night-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            border: 1px solid #f0f0f0;
            position: relative;
            overflow: hidden;
        }

        .card-number {
            position: absolute;
            top: 20px;
            right: 24px;
            background: #1a1a1a;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .card-question {
            font-size: 1.25rem;
            color: #1a1a1a;
            line-height: 1.6;
            margin: 20px 0 40px 0;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .card-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .progress-indicator {
            text-align: center;
            margin-bottom: 20px;
            color: #6b7280;
            font-size: 1.1em;
        }

        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-indicator.syncing {
            background: #f59e0b;
        }

        .sync-indicator.error {
            background: #ef4444;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .mode-btn {
                min-width: 150px;
                padding: 15px 20px;
            }
            
            .date-night-card {
                padding: 25px;
            }
            
            .card-question {
                font-size: 1.1em;
            }

            .reflection-areas {
                grid-template-columns: 1fr;
            }

            .journal-header h2 {
                font-size: 1.6em;
            }

            .journal-card {
                padding: 20px;
            }

            .user-profile {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
                justify-content: center;
            }

            .login-container {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sync Indicator -->
        <div id="syncIndicator" class="sync-indicator hidden">
            <span id="syncIcon">üîÑ</span>
            <span id="syncText">Synced</span>
        </div>

        <!-- User Profile (shown when logged in) -->
        <div id="userProfile" class="user-profile hidden">
            <div class="user-avatar" id="userAvatar">üë§</div>
            <span class="user-name" id="userName"></span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <!-- Login/Signup View -->
        <div id="loginView" class="login-container">
            <div class="logo-container">
                <div class="logo" id="appLogo">
                    <img src="https://raw.githubusercontent.com/chanellejanae/kingdomconnection/main/logo.png" alt="Kingdom Connection Logo" onerror="this.style.display='none'; this.parentElement.innerHTML='üíï';">
                </div>
            </div>
            <h2 style="color: #4a5568; margin-bottom: 30px;">Welcome to Kingdom Connection</h2>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="login-form">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn">Sign In</button>
                    <button type="button" class="btn btn-secondary" onclick="showSignup()">Create Account</button>
                </div>
            </form>

            <form id="signupForm" class="hidden" onsubmit="handleSignup(event)">
                <div class="login-form">
                    <div class="form-group">
                        <label for="signupName">Your Name</label>
                        <input type="text" id="signupName" placeholder="Enter your name" required>
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Create a password" required minlength="6">
                    </div>
                    <button type="submit" class="btn">Create Account</button>
                    <button type="button" class="btn btn-secondary" onclick="showLogin()">Back to Sign In</button>
                </div>
            </form>
        </div>

        <!-- Connection Setup View -->
        <div id="connectionView" class="hidden">
            <div class="header">
                <div class="logo-container">
                    <div class="logo" id="connectionLogo">
                        <img src="https://raw.githubusercontent.com/chanellejanae/kingdomconnection/main/logo.png" alt="Kingdom Connection Logo" onerror="this.style.display='none'; this.parentElement.innerHTML='üíï';">
                    </div>
                </div>
                <h1>üíï Kingdom Connection</h1>
                <p>Connect with your partner to start your journey together</p>
            </div>

            <div class="connection-status">
                <h3 style="color: #4a5568; margin-bottom: 15px;">Connection Status</h3>
                <div id="connectionContent">
                    <p>Share this code with your partner:</p>
                    <div class="connection-code" id="connectionCode"></div>
                    <p style="color: #718096; font-size: 0.9em;">Or enter your partner's code below:</p>
                    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 15px;">
                        <input type="text" id="partnerCode" placeholder="Enter partner's code" style="padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; font-size: 0.875rem; letter-spacing: 1px; font-family: 'Inter', monospace; transition: all 0.2s ease;">
                        <button class="btn" onclick="connectWithPartner()">Connect</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main App (shown when connected) -->
        <div id="mainApp" class="hidden">
            <div class="header">
                <div class="logo-container">
                    <div class="logo" id="mainLogo">
                        <img src="https://raw.githubusercontent.com/chanellejanae/kingdomconnection/main/logo.png" alt="Kingdom Connection Logo" onerror="this.style.display='none'; this.parentElement.innerHTML='üíï';">
                    </div>
                </div>
                <h1>üíï Kingdom Connection</h1>
                <p>Deepen your relationship through meaningful conversations and shared faith</p>
            </div>

            <div id="modeSelector" class="mode-selector">
                <button class="mode-btn active" onclick="showJournal()">
                    üìñ Daily Journal<br>
                    <small>One meaningful question each day</small>
                </button>
                <button class="mode-btn" onclick="showDateNight()">
                    üíù Date Night Cards<br>
                    <small>200 conversation starters</small>
                </button>
                <button class="mode-btn" onclick="showHistory()">
                    üìö Reflection History<br>
                    <small>View and export past entries</small>
                </button>
            </div>

            <div id="journalView" class="hidden">
                <div class="journal-container">
                    <div class="journal-header">
                        <h2>üíï Daily Reflection Journal</h2>
                        <p>Take time to reflect individually, then share your hearts together</p>
                    </div>
                    
                    <div class="journal-card">
                        <h3>üåÖ Today's Question</h3>
                        <p style="color: #718096; margin: 0 0 15px 0; font-size: 0.9rem;" id="todaysDate"></p>
                        <div class="question-category-badge" id="questionCategoryBadge"></div>
                        <div class="daily-question" id="dailyQuestion"></div>
                        <button class="btn btn-secondary" onclick="getNewDailyQuestion()">üé≤ New Question</button>
                    </div>
                    
                    <div class="reflection-areas">
                        <div class="partner-reflection">
                            <div class="partner-profile" id="currentUserProfile">
                                <div class="partner-avatar" id="currentUserAvatar">üë§</div>
                                <div class="partner-info">
                                    <h4 id="currentUserName">Your Reflection</h4>
                                </div>
                            </div>
                            <textarea id="currentUserReflection" placeholder="Take time to reflect on today's question..." oninput="autoSaveReflection()"></textarea>
                        </div>
                        <div class="partner-reflection">
                            <div class="partner-profile" id="partnerProfile">
                                <div class="partner-avatar" id="partnerAvatar">üíï</div>
                                <div class="partner-info">
                                    <h4 id="partnerName">Partner's Reflection</h4>
                                </div>
                            </div>
                            <textarea id="partnerReflection" placeholder="Your partner's reflection will appear here..." readonly></textarea>
                        </div>
                    </div>

                    <div class="journal-controls">
                        <button class="btn" onclick="saveJournalEntry()">üíæ Save Entry</button>
                        <button class="btn btn-secondary" onclick="clearJournal()">üóëÔ∏è Clear All</button>
                    </div>
                </div>
            </div>

            <div id="dateNightView" class="hidden">
                <div class="progress-indicator" id="dateNightProgress"></div>
                <div class="date-night-card">
                    <div class="card-number" id="cardNumber"></div>
                    <div class="card-question" id="dateNightQuestion"></div>
                    <div class="card-controls">
                        <button class="btn btn-secondary" onclick="shuffleDateNight()">üîÄ Shuffle</button>
                        <button class="btn" onclick="nextDateNightCard()">Next Card ‚Üí</button>
                        <button class="btn btn-secondary" onclick="resetDateNight()">‚Üª Reset Deck</button>
                    </div>
                </div>
            </div>

            <div id="historyView" class="hidden">
                <div class="journal-container">
                    <div class="journal-header">
                        <h2>üìö Reflection History</h2>
                        <p>Browse through your journey of growth and connection</p>
                    </div>
                    
                    <div id="historyEntries" class="history-entries">
                        <p style="text-align: center; color: #9ca3af; font-style: italic;">No journal entries yet. Start writing to see your history here!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const categories = {
            "üåø Spiritual Growth + Faith": [
                "How has God been speaking to your heart this week?",
                "What's a recent way you've seen God answer prayer in your life?",
                "How can we encourage each other to spend more time with God daily?",
                "What is a scripture you want to memorize together this month?",
                "When do you feel closest to God ‚Äî in joy, in struggle, or both?"
            ],
            "üí¨ Emotional Intimacy": [
                "What's one thing I do that makes you feel truly seen and understood?",
                "How can I better support you when you're going through a difficult time?",
                "What's something you've been thinking about that you haven't shared with me yet?",
                "How do you prefer to be comforted when you're feeling sad or overwhelmed?",
                "What's one fear or worry you have that I could help you process?"
            ],
            "üíû Relationship Reflection": [
                "How have we grown as a couple in the past few months?",
                "What's something you've learned about me that surprised you (in a good way)?",
                "How do we bring out the best in each other?",
                "What do you envision our relationship looking like one year from now?",
                "What kind of marriage do you want to build one day?"
            ]
        };

        const dateNightQuestions = [
            // Faith & Spiritual Connection (50 questions)
            "If you could ask God one question about our relationship, what would it be?",
            "What's one way you see God's hand in bringing us together?",
            "How do you want us to pray together as a couple?",
            "What Bible verse do you think describes our love story?",
            "If we could serve God together anywhere in the world, where would you choose?",
            "What's a spiritual goal you have for us this year?",
            "How has your faith grown since we've been together?",
            "What's your favorite way to worship God together?",
            "If we wrote a prayer for our relationship, what would it say?",
            "What Christian couple do you most admire and why?",
            "How do you see us honoring God in our daily life together?",
            "What's one way I help you grow closer to Jesus?",
            "If we could ask a biblical couple for relationship advice, who would it be?",
            "What does 'equally yoked' mean to you in our relationship?",
            "How do you want us to handle disagreements in a Christ-like way?",
            "What's your favorite thing about praying with me?",
            "If we could lead a ministry together, what would it be?",
            "How do you see God using our relationship to impact others?",
            "What's a worship song that reminds you of us?",
            "How do you want us to celebrate God's goodness together?",
            "What's one way we can better support each other's spiritual growth?",
            "If we could have dinner with any Christian leader, who would it be?",
            "What does it mean to you to have a godly relationship?",
            "How do you see us encouraging other couples in their faith?",
            "What's your favorite Bible story about love or marriage?",
            "How do you want us to handle stress in a way that honors God?",
            "What's one spiritual discipline you'd like us to do together?",
            "If we could plant a church together, what would it focus on?",
            "How has God used you to bless my life?",
            "What's your vision for our family's spiritual legacy?",
            "How do you see us growing in wisdom together?",
            "What's one way we can better love our neighbors as a couple?",
            "If we could write a devotional together, what would the theme be?",
            "How do you want us to handle success in a humble way?",
            "What's your favorite thing about studying the Bible together?",
            "How do you see God preparing us for marriage?",
            "What's one way we can better steward the gifts God has given us?",
            "If we could go on a mission trip together, where would we go?",
            "How do you want us to celebrate the Sabbath as a couple?",
            "What's your favorite way to see God's creation together?",
            "How do you see us encouraging each other during difficult seasons?",
            "What's one way we can better practice hospitality together?",
            "If we could memorize a book of the Bible together, which would it be?",
            "How do you want us to handle money in a way that honors God?",
            "What's your favorite thing about our spiritual conversations?",
            "How do you see us growing in patience and kindness together?",
            "What's one way we can better serve our community as a couple?",
            "If we could start a tradition to honor God, what would it be?",
            "How do you want us to celebrate God's faithfulness in our relationship?",
            "What's your vision for how we'll raise children in the faith?",

            // Dreams & Future (50 questions)
            "How do you think our love story will be different in 10 years?",
            "What's one dream you have that you've never told anyone?",
            "If we could live anywhere in the world for a year, where would it be?",
            "What does your ideal Sunday morning look like with me?",
            "If money wasn't a factor, what would you want to do with your life?",
            "What's one adventure you want us to go on together?",
            "How do you picture our home looking in 5 years?",
            "What's a skill you'd love for us to learn together?",
            "If we could start a business together, what would it be?",
            "What's your biggest hope for our relationship?",
            "How many children do you want, and what would you name them?",
            "What's one place you want to travel with me before we're 30?",
            "If we could build our dream house, what would be the most important room?",
            "What's a tradition you want to start in our family?",
            "How do you want to celebrate our 50th wedding anniversary?",
            "What's one way you want to make the world better together?",
            "If we could retire anywhere, where would you choose?",
            "What's your vision for how we'll spend our golden years?",
            "What's one goal you have for us to accomplish this year?",
            "If we could take a year off to pursue a passion, what would it be?",
            "What's your dream vacation with me?",
            "How do you want us to handle career changes and big decisions?",
            "What's one way you want us to stay connected as we get older?",
            "If we could learn any language together, which would it be?",
            "What's your vision for our family's Christmas traditions?",
            "How do you want us to celebrate each other's achievements?",
            "What's one hobby you'd love for us to share?",
            "If we could write a book together, what would it be about?",
            "What's your dream for how we'll support each other's careers?",
            "How do you picture us staying young at heart together?",
            "What's one way you want us to invest in our community long-term?",
            "If we could have any pet together, what would it be?",
            "What's your vision for how we'll handle aging parents?",
            "How do you want us to celebrate milestone birthdays?",
            "What's one legacy you want us to leave together?",
            "If we could take a class together, what would you choose?",
            "What's your dream for our wedding day (or renewal of vows)?",
            "How do you want us to handle life's unexpected challenges?",
            "What's one way you want us to stay playful throughout our marriage?",
            "If we could volunteer together regularly, what cause would you choose?",
            "What's your vision for how we'll make decisions as a team?",
            "How do you want us to celebrate our love story each year?",
            "What's one adventure sport or activity you'd try with me?",
            "If we could have a second home anywhere, where would it be?",
            "What's your dream for how we'll handle disagreements?",
            "How do you want us to surprise each other throughout our marriage?",
            "What's one way you want us to keep learning and growing together?",
            "If we could start a family foundation, what would it support?",
            "What's your vision for how we'll stay best friends forever?",
            "How do you want us to create new memories every year?",

            // Deep Connection & Understanding (50 questions)
            "What's one thing about me that you hope never changes?",
            "What's the most romantic thing someone could do that doesn't cost any money?",
            "When do you feel most loved by me?",
            "What's one way I make you feel safe and secure?",
            "What's your favorite memory of us so far?",
            "How do you prefer to be comforted when you're upset?",
            "What's one thing you've learned about love from our relationship?",
            "What makes you feel most appreciated in our relationship?",
            "What's your favorite way for us to spend quality time together?",
            "How do you know when I'm really listening to you?",
            "What's one way I've helped you become a better person?",
            "What does intimacy mean to you beyond the physical?",
            "What's your favorite thing about how we communicate?",
            "How do you like to be encouraged when you're facing challenges?",
            "What's one way we bring out the best in each other?",
            "What makes you feel most connected to me?",
            "What's your favorite way for me to show affection?",
            "How do you prefer to resolve conflicts with me?",
            "What's one thing about our relationship that makes you smile?",
            "What makes you feel most understood by me?",
            "What's your favorite way for us to be spontaneous together?",
            "How do you like to celebrate good news with me?",
            "What's one way I support your dreams and goals?",
            "What makes you feel most cherished in our relationship?",
            "What's your favorite inside joke or memory we share?",
            "How do you prefer to spend quiet moments together?",
            "What's one way our relationship has surprised you?",
            "What makes you feel most grateful for our love?",
            "What's your favorite way for us to be silly together?",
            "How do you like to be reassured when you're feeling insecure?",
            "What's one thing about our chemistry that you love?",
            "What makes you feel most proud of our relationship?",
            "What's your favorite way for us to support each other's growth?",
            "How do you prefer to share your feelings with me?",
            "What's one way our love has changed you for the better?",
            "What makes you feel most excited about our future?",
            "What's your favorite way for us to be romantic?",
            "How do you like to be surprised by me?",
            "What's one thing about our partnership that you treasure?",
            "What makes you feel most confident in our relationship?",
            "What's your favorite way for us to laugh together?",
            "How do you prefer to handle stress as a couple?",
            "What's one way I make ordinary moments special?",
            "What makes you feel most hopeful about our love?",
            "What's your favorite way for us to be adventurous together?",
            "How do you like to be pampered or cared for by me?",
            "What's one thing about our love story that you'd never change?",
            "What makes you feel most blessed to be with me?",
            "What's your favorite way for us to create new traditions?",
            "How do you prefer to end each day together?",

            // Personal Growth & Values (50 questions)
            "What's one fear you're working on overcoming?",
            "What does success mean to you in life?",
            "What's a childhood dream you still think about?",
            "How do you want to be remembered by others?",
            "What's one way you've grown in the past year?",
            "What values are most important to you in a relationship?",
            "What's something you're really proud of about yourself?",
            "How do you handle stress, and how can I support you?",
            "What's one habit you'd like to develop or break?",
            "What makes you feel most confident and empowered?",
            "What's your biggest strength, and how do you use it?",
            "How do you prefer to recharge when you're feeling drained?",
            "What's one lesson life has taught you that you'd share with others?",
            "What does forgiveness mean to you?",
            "What's something you're currently learning about yourself?",
            "How do you define a life well-lived?",
            "What's one way you want to challenge yourself this year?",
            "What makes you feel most fulfilled and purposeful?",
            "What's your approach to making difficult decisions?",
            "How do you handle disappointment or setbacks?",
            "What's one thing you wish more people understood about you?",
            "What does loyalty mean to you in relationships?",
            "What's your biggest motivation in life right now?",
            "How do you prefer to celebrate your accomplishments?",
            "What's one way you want to make a difference in the world?",
            "What does authenticity mean to you?",
            "What's something you're passionate about that others might not know?",
            "How do you maintain hope during difficult times?",
            "What's one piece of advice you'd give your younger self?",
            "What makes you feel most grateful in life?",
            "What's your approach to setting and achieving goals?",
            "How do you define true friendship?",
            "What's one way you've learned to love yourself better?",
            "What does courage look like in your daily life?",
            "What's something you're excited to learn or try?",
            "How do you handle criticism or feedback?",
            "What's one way you want to grow spiritually this year?",
            "What makes you feel most at peace?",
            "What's your philosophy on work-life balance?",
            "How do you prefer to help others in need?",
            "What's one thing you've learned about resilience?",
            "What does generosity mean to you?",
            "What's something you're working on accepting about yourself?",
            "How do you cultivate joy in your everyday life?",
            "What's one way you want to be a better person?",
            "What does wisdom mean to you?",
            "What's something you're grateful your parents taught you?",
            "How do you handle change and uncertainty?",
            "What's one way you want to leave the world better than you found it?",
            "What makes you feel most alive and energized?",

            // Fun & Lighthearted (50 questions)
            "If you could have any superpower for a day, what would it be?",
            "What's the most embarrassing thing that's ever happened to you?",
            "If you could be famous for something, what would it be?",
            "What's your weirdest food combination that you actually love?",
            "If you could live in any TV show or movie, which would you choose?",
            "What's the funniest thing that's ever happened to us?",
            "If you could have dinner with any three people, living or dead, who would they be?",
            "What's your most irrational fear?",
            "If you could instantly become an expert at something, what would it be?",
            "What's the best compliment you've ever received?",
            "If you could time travel, would you go to the past or future?",
            "What's your guilty pleasure that you're not actually guilty about?",
            "If you could switch lives with anyone for a week, who would it be?",
            "What's the most spontaneous thing you've ever done?",
            "If you could have any animal as a pet, what would it be?",
            "What's your favorite way to waste time?",
            "If you could eliminate one thing from daily life, what would it be?",
            "What's the best gift you've ever given someone?",
            "If you could add one room to our future house, what would it be?",
            "What's your favorite childhood game or activity?",
            "If you could master any instrument overnight, which would you choose?",
            "What's the most beautiful place you've ever seen?",
            "If you could have any job for just one day, what would it be?",
            "What's your favorite way to make someone smile?",
            "If you could bring back any fashion trend, what would it be?",
            "What's the best advice you've ever received?",
            "If you could have any fictional character as a best friend, who would it be?",
            "What's your favorite family tradition or memory?",
            "If you could invent something to make life easier, what would it be?",
            "What's the most adventurous thing on your bucket list?",
            "If you could have any view from your bedroom window, what would it be?",
            "What's your favorite way to celebrate small victories?",
            "If you could be really good at any sport, which would you choose?",
            "What's the kindest thing a stranger has ever done for you?",
            "If you could have any magical ability, what would it be?",
            "What's your favorite thing about your personality?",
            "If you could redesign the human body, what would you change?",
            "What's the most interesting conversation you've ever had?",
            "If you could have any celebrity as a neighbor, who would it be?",
            "What's your favorite way to surprise people?",
            "If you could live in any historical time period, when would it be?",
            "What's the most creative thing you've ever done?",
            "If you could have any question answered, what would you ask?",
            "What's your favorite thing about being your age right now?",
            "If you could change one thing about how you were raised, what would it be?",
            "What's the most meaningful gift you've ever received?",
            "If you could have any talent that you don't currently have, what would it be?",
            "What's your favorite way to make an ordinary day special?",
            "If you could give everyone in the world one piece of advice, what would it be?",
            "What's the best thing about being in love with me?"
        ];

        let currentView = 'login';
        let currentDateNightIndex = 0;
        let shuffledDateNightQuestions = [...dateNightQuestions];
        let allQuestions = [];
        let currentDailyQuestion = '';
        let currentQuestionCategory = '';
        let currentUser = null;
        let partnerUser = null;
        let coupleId = null;
        let journalListener = null;

        // Firebase helper functions
        function showSyncStatus(status, message) {
            const indicator = document.getElementById('syncIndicator');
            const icon = document.getElementById('syncIcon');
            const text = document.getElementById('syncText');
            
            indicator.className = 'sync-indicator';
            
            switch(status) {
                case 'syncing':
                    indicator.classList.add('syncing');
                    icon.textContent = 'üîÑ';
                    text.textContent = message || 'Syncing...';
                    break;
                case 'synced':
                    icon.textContent = '‚úÖ';
                    text.textContent = message || 'Synced';
                    break;
                case 'error':
                    indicator.classList.add('error');
                    icon.textContent = '‚ùå';
                    text.textContent = message || 'Sync Error';
                    break;
            }
            
            indicator.classList.remove('hidden');
            
            if (status === 'synced') {
                setTimeout(() => {
                    indicator.classList.add('hidden');
                }, 2000);
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showMessage('Please fill in all fields', 'error');
                return;
            }

            try {
                showSyncStatus('syncing', 'Signing in...');
                const { signInWithEmailAndPassword } = window.firebaseModules;
                const userCredential = await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                
                // Get user data from Firestore
                const { doc, getDoc } = window.firebaseModules;
                const userDoc = await getDoc(doc(window.firebaseDb, 'users', userCredential.user.uid));
                
                if (userDoc.exists()) {
                    currentUser = { id: userCredential.user.uid, ...userDoc.data() };
                    showSyncStatus('synced', 'Signed in!');
                    showMessage('Login successful!', 'success');
                    setTimeout(() => showConnectionView(), 1000);
                } else {
                    showSyncStatus('error', 'Profile not found');
                    showMessage('User profile not found', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showSyncStatus('error', 'Sign in failed');
                showMessage('Invalid email or password', 'error');
            }
        }

        async function signup() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            
            if (!name || !email || !password) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }

            try {
                showSyncStatus('syncing', 'Creating account...');
                const { createUserWithEmailAndPassword } = window.firebaseModules;
                const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                
                // Generate connection code
                const connectionCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                
                // Save user data to Firestore
                const { doc, setDoc } = window.firebaseModules;
                const userData = {
                    name: name,
                    email: email,
                    connectionCode: connectionCode,
                    partnerId: null,
                    createdAt: new Date().toISOString()
                };
                
                await setDoc(doc(window.firebaseDb, 'users', userCredential.user.uid), userData);
                
                currentUser = { id: userCredential.user.uid, ...userData };
                showSyncStatus('synced', 'Account created!');
                showMessage('Account created successfully!', 'success');
                setTimeout(() => showConnectionView(), 1000);
            } catch (error) {
                console.error('Signup error:', error);
                showSyncStatus('error', 'Account creation failed');
                showMessage('Error creating account: ' + error.message, 'error');
            }
        }

        async function connectWithPartner() {
            const partnerCode = document.getElementById('partnerCode').value.toUpperCase().trim();
            
            if (!partnerCode) {
                showMessage('Please enter your partner\'s code', 'error');
                return;
            }

            try {
                showSyncStatus('syncing', 'Connecting...');
                
                // Find partner by connection code
                const { collection, query, where, getDocs, doc, updateDoc } = window.firebaseModules;
                const usersRef = collection(window.firebaseDb, 'users');
                const q = query(usersRef, where('connectionCode', '==', partnerCode));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    showSyncStatus('error', 'Code not found');
                    showMessage('Connection code not found', 'error');
                    return;
                }
                
                const partnerDoc = querySnapshot.docs[0];
                const partnerData = partnerDoc.data();
                const partnerId = partnerDoc.id;
                
                // Create couple ID (smaller ID first for consistency)
                coupleId = [currentUser.id, partnerId].sort().join('_');
                
                // Update both users with partner info
                await updateDoc(doc(window.firebaseDb, 'users', currentUser.id), {
                    partnerId: partnerId,
                    coupleId: coupleId
                });
                
                await updateDoc(doc(window.firebaseDb, 'users', partnerId), {
                    partnerId: currentUser.id,
                    coupleId: coupleId
                });
                
                currentUser.partnerId = partnerId;
                currentUser.coupleId = coupleId;
                partnerUser = { id: partnerId, ...partnerData };
                
                showSyncStatus('synced', 'Connected!');
                showMessage('Connected successfully!', 'success');
                setTimeout(() => showMainApp(), 1000);
            } catch (error) {
                console.error('Connection error:', error);
                showSyncStatus('error', 'Connection failed');
                showMessage('Error connecting: ' + error.message, 'error');
            }
        }

        async function saveJournalEntry() {
            if (!coupleId) {
                showMessage('Please connect with your partner first', 'error');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const reflection = document.getElementById('currentUserReflection').value;
            
            if (!reflection.trim()) {
                showMessage('Please write a reflection first', 'error');
                return;
            }

            try {
                showSyncStatus('syncing', 'Saving...');
                
                const { doc, setDoc } = window.firebaseModules;
                const entryData = {
                    date: today,
                    question: currentDailyQuestion,
                    category: currentQuestionCategory,
                    [`${currentUser.id}_reflection`]: reflection,
                    [`${currentUser.id}_name`]: currentUser.name,
                    lastUpdated: new Date().toISOString(),
                    updatedBy: currentUser.id
                };
                
                await setDoc(doc(window.firebaseDb, 'journal_entries', `${coupleId}_${today}`), entryData, { merge: true });
                
                showSyncStatus('synced', 'Saved!');
                showMessage('Journal entry saved and synced!', 'success');
            } catch (error) {
                console.error('Save error:', error);
                showSyncStatus('error', 'Save failed');
                showMessage('Error saving entry: ' + error.message, 'error');
            }
        }

        function setupJournalListener() {
            if (!coupleId || journalListener) return;
            
            const today = new Date().toISOString().split('T')[0];
            const { doc, onSnapshot } = window.firebaseModules;
            
            journalListener = onSnapshot(
                doc(window.firebaseDb, 'journal_entries', `${coupleId}_${today}`),
                (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        
                        // Update partner's reflection if it exists
                        if (partnerUser && data[`${partnerUser.id}_reflection`]) {
                            document.getElementById('partnerReflection').value = data[`${partnerUser.id}_reflection`];
                            
                            // Show notification if partner just updated
                            if (data.updatedBy === partnerUser.id && data.lastUpdated) {
                                const updateTime = new Date(data.lastUpdated);
                                const now = new Date();
                                if (now - updateTime < 10000) { // Within last 10 seconds
                                    showMessage('üíï Your partner just updated their reflection!', 'success');
                                }
                            }
                        }
                        
                        // Load current user's reflection
                        if (data[`${currentUser.id}_reflection`]) {
                            document.getElementById('currentUserReflection').value = data[`${currentUser.id}_reflection`];
                        }
                        
                        // Load question if it exists
                        if (data.question && data.category) {
                            currentDailyQuestion = data.question;
                            currentQuestionCategory = data.category;
                            document.getElementById('dailyQuestion').textContent = currentDailyQuestion;
                            document.getElementById('questionCategoryBadge').textContent = currentQuestionCategory;
                        }
                    }
                },
                (error) => {
                    console.error('Journal listener error:', error);
                    showSyncStatus('error', 'Sync error');
                }
            );
        }

        function handleLogin(event) {
            event.preventDefault();
            login();
        }

        function handleSignup(event) {
            event.preventDefault();
            signup();
        }

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
        }

        function showSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        }

        function showMessage(message, type = 'info') {
            const existingMessage = document.querySelector('.message-overlay');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageOverlay = document.createElement('div');
            messageOverlay.className = 'message-overlay';
            messageOverlay.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: ${type === 'error' ? '#fed7d7' : type === 'success' ? '#c6f6d5' : '#bee3f8'};
                color: ${type === 'error' ? '#c53030' : type === 'success' ? '#2f855a' : '#2c5282'};
                padding: 15px 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                border-left: 4px solid ${type === 'error' ? '#e53e3e' : type === 'success' ? '#38a169' : '#3182ce'};
                max-width: 300px; animation: slideIn 0.3s ease;
            `;
            messageOverlay.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>${type === 'error' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(messageOverlay);

            setTimeout(() => {
                if (messageOverlay.parentNode) {
                    messageOverlay.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => messageOverlay.remove(), 300);
                }
            }, 4000);
        }

        async function showConnectionView() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('connectionView').classList.remove('hidden');
            document.getElementById('userProfile').classList.remove('hidden');
            
            updateUserProfile();
            
            if (currentUser.partnerId) {
                // Load partner data and show main app
                try {
                    const { doc, getDoc } = window.firebaseModules;
                    const partnerDoc = await getDoc(doc(window.firebaseDb, 'users', currentUser.partnerId));
                    if (partnerDoc.exists()) {
                        partnerUser = { id: currentUser.partnerId, ...partnerDoc.data() };
                        coupleId = currentUser.coupleId;
                        showMainApp();
                    }
                } catch (error) {
                    console.error('Error loading partner:', error);
                }
            } else {
                document.getElementById('connectionCode').textContent = currentUser.connectionCode;
            }
        }

        function updateUserProfile() {
            document.getElementById('userName').textContent = currentUser.name;
            const userAvatar = document.getElementById('userAvatar');
            userAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
        }

        function showMainApp() {
            document.getElementById('connectionView').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update partner info in journal
            if (partnerUser) {
                document.getElementById('partnerName').textContent = `${partnerUser.name}'s Reflection`;
                document.getElementById('partnerAvatar').textContent = partnerUser.name.charAt(0).toUpperCase();
            }
            
            // Update current user info in journal
            document.getElementById('currentUserName').textContent = 'Your Reflection';
            document.getElementById('currentUserAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            
            initializeJournal();
            setupJournalListener();
            showJournal();
        }

        async function logout() {
            try {
                if (journalListener) {
                    journalListener();
                    journalListener = null;
                }
                
                const { signOut } = window.firebaseModules;
                await signOut(window.firebaseAuth);
                
                currentUser = null;
                partnerUser = null;
                coupleId = null;
                
                document.getElementById('userProfile').classList.add('hidden');
                document.getElementById('connectionView').classList.add('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginView').classList.remove('hidden');
                document.getElementById('syncIndicator').classList.add('hidden');
                
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                showLogin();
                
                showMessage('Logged out successfully', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showMessage('Error logging out', 'error');
            }
        }

        function initializeQuestions() {
            allQuestions = [];
            for (let category in categories) {
                categories[category].forEach(question => {
                    allQuestions.push({ category, question });
                });
            }
        }

        function initializeJournal() {
            getNewDailyQuestion();
        }

        function getNewDailyQuestion() {
            if (allQuestions.length === 0) {
                initializeQuestions();
            }
            
            const randomIndex = Math.floor(Math.random() * allQuestions.length);
            const selectedQuestion = allQuestions[randomIndex];
            
            currentDailyQuestion = selectedQuestion.question;
            currentQuestionCategory = selectedQuestion.category;
            
            document.getElementById('dailyQuestion').textContent = currentDailyQuestion;
            document.getElementById('questionCategoryBadge').textContent = currentQuestionCategory;
        }

        function autoSaveReflection() {
            // Auto-save could be implemented here with debouncing
        }

        function clearJournal() {
            document.getElementById('currentUserReflection').value = '';
            showMessage('Journal cleared', 'info');
        }

        function showJournal() {
            setActiveMode('journal');
            document.getElementById('journalView').classList.remove('hidden');
            document.getElementById('dateNightView').classList.add('hidden');
            document.getElementById('historyView').classList.add('hidden');
        }

        function showDateNight() {
            setActiveMode('dateNight');
            document.getElementById('journalView').classList.add('hidden');
            document.getElementById('dateNightView').classList.remove('hidden');
            document.getElementById('historyView').classList.add('hidden');
            
            if (currentDateNightIndex === 0) {
                displayDateNightCard();
            }
        }

        function showHistory() {
            setActiveMode('history');
            document.getElementById('journalView').classList.add('hidden');
            document.getElementById('dateNightView').classList.add('hidden');
            document.getElementById('historyView').classList.remove('hidden');
        }

        function setActiveMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            
            if (mode === 'journal') {
                document.querySelector('.mode-btn').classList.add('active');
            } else if (mode === 'dateNight') {
                document.querySelectorAll('.mode-btn')[1].classList.add('active');
            } else if (mode === 'history') {
                document.querySelectorAll('.mode-btn')[2].classList.add('active');
            }
        }

        function displayDateNightCard() {
            document.getElementById('dateNightQuestion').textContent = shuffledDateNightQuestions[currentDateNightIndex];
            document.getElementById('cardNumber').textContent = `${currentDateNightIndex + 1} / ${shuffledDateNightQuestions.length}`;
            document.getElementById('dateNightProgress').textContent = `Card ${currentDateNightIndex + 1} of ${shuffledDateNightQuestions.length}`;
        }

        function nextDateNightCard() {
            currentDateNightIndex = (currentDateNightIndex + 1) % shuffledDateNightQuestions.length;
            displayDateNightCard();
        }

        function shuffleDateNight() {
            shuffledDateNightQuestions = [...dateNightQuestions].sort(() => Math.random() - 0.5);
            currentDateNightIndex = 0;
            displayDateNightCard();
            showMessage('Cards shuffled!', 'info');
        }

        function resetDateNight() {
            shuffledDateNightQuestions = [...dateNightQuestions];
            currentDateNightIndex = 0;
            displayDateNightCard();
            showMessage('Deck reset to original order', 'info');
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Firebase is available
            if (!window.firebaseAuth) {
                showMessage('Firebase not loaded. Please check your internet connection.', 'error');
                return;
            }
            
            // Listen for auth state changes
            const { onAuthStateChanged } = window.firebaseModules;
            onAuthStateChanged(window.firebaseAuth, async (user) => {
                if (user) {
                    try {
                        const { doc, getDoc } = window.firebaseModules;
                        const userDoc = await getDoc(doc(window.firebaseDb, 'users', user.uid));
                        if (userDoc.exists()) {
                            currentUser = { id: user.uid, ...userDoc.data() };
                            showConnectionView();
                        }
                    } catch (error) {
                        console.error('Error loading user data:', error);
                    }
                }
            });
            
            initializeQuestions();
            shuffleDateNightQuestions = [...dateNightQuestions];
            
            const today = new Date();
            const dateString = today.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const todaysDateElement = document.getElementById('todaysDate');
            if (todaysDateElement) {
                todaysDateElement.textContent = dateString;
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f23e6977157adc',t:'MTc2MDU2MjAwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
